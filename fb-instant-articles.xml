<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title></title>
    <link>https://gabrielweyer.github.io/</link>
    <description>
      My name is Gabriel Weyer. I’m a software developer and currently based in Melbourne, Australia. I blog about technology.
    </description>
    
        
            <item>
                <title>Advanced .NET Debugging #1</title>
                <link>https://gabrielweyer.github.io//2018/04/07/advanced-dotnet-debugging-1/</link>
                <content:encoded>
                    <![CDATA[
                    <p>After eyeing it for a while I finally decided to buy <a href="https://www.goodreads.com/book/show/7306509-advanced-net-debugging">Advanced .NET Debugging</a> by Mario Hewardt. I’ve been studying <code class="highlighter-rouge">WinDbg</code> for some time and consider myself somewhere between beginner and intermediate level. To my dismay I got stuck on the first excercise! Luckily I didn’t give up and finally stumbled on a blog post that unblocked me. This series has for goal to make <a href="https://www.goodreads.com/book/show/7306509-advanced-net-debugging">Advanced .NET Debugging</a> more accessible to people - quite like me - that haven’t grasped all the concepts yet.</p>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
  <li>A hex viewer
    <ul>
      <li>I used the <a href="https://marketplace.visualstudio.com/items?itemName=slevesque.vscode-hexdump">hexdump for VSCode</a> Visual Studio Code extension</li>
    </ul>
  </li>
  <li><a href="https://github.com/gabrielweyer/nuggets/blob/master/windbg/README.md#download-and-install-windbg">WinDbg</a></li>
  <li>Windows<!--more--></li>
</ul>

<h2 id="the-problem">The problem</h2>

<p>In the section <strong>Loading Native Images</strong>, Mario explains how Windows is loading a native image using <code class="highlighter-rouge">Notepad.exe</code> (<code class="highlighter-rouge">%SystemRoot%\notepad.exe</code>) as an example. As the first step, Mario instructs the reader to:</p>

<blockquote>
  <p>go to file offset <code class="highlighter-rouge">0x108</code> where you will find the <code class="highlighter-rouge">AddressOfEntryPoint</code> field</p>
</blockquote>

<p>The book was written a few years ago and back then Mario was running <code class="highlighter-rouge">Windows Vista</code> (most likely in <code class="highlighter-rouge">32-bit</code> too). If you look at the same file offset in <code class="highlighter-rouge">Windows 10 64-bit</code> you’ll be disapointed:</p>

<p><img src="/assets/advanced-dotnet-debugging-1/no-address-of-entry-point.png" alt="No AddressOfEntryPoint" /></p>

<p>OK, there are quite a few things to unpack in this screenshot.</p>

<h3 id="hexadecimal">Hexadecimal</h3>

<p>Each white cell represents a <code class="highlighter-rouge">byte</code>. A <code class="highlighter-rouge">byte</code> has 256 different values (from <code class="highlighter-rouge">0</code> to <code class="highlighter-rouge">255</code>). If we want to represent the value <code class="highlighter-rouge">255</code> in <code class="highlighter-rouge">base 2</code> (<code class="highlighter-rouge">binary</code>), we would need 8 characters: <code class="highlighter-rouge">11111111</code>. The same value in <code class="highlighter-rouge">base 10</code> (<code class="highlighter-rouge">decimal</code>) still requires 3 characters: <code class="highlighter-rouge">255</code>. In <code class="highlighter-rouge">base 16</code> (<code class="highlighter-rouge">hexadecimal</code>) we only need 2 characters: <code class="highlighter-rouge">FF</code>. Hence <code class="highlighter-rouge">hexadecimal</code> strikes a good balance between brevity and not being too remote from the decimal base we human-beings use. You can use the <code class="highlighter-rouge">Windows 10</code> calculator in <code class="highlighter-rouge">Programmer</code> mode to convert between <code class="highlighter-rouge">hexadecimal</code> and <code class="highlighter-rouge">decimal</code>:</p>

<p><img src="/assets/advanced-dotnet-debugging-1/win-10-calc.png" alt="Convert between hex and dec" /></p>

<h3 id="file-offset">File offset</h3>

<p>The <code class="highlighter-rouge">byte</code>s are displayed from left to right and top to bottom. They are accessed via a <strong>file offset</strong>, represented by the blue numbers. The left column represents the 7 most significant digits while the top row represents the least significant digit.</p>

<p><img src="/assets/advanced-dotnet-debugging-1/file-offset.png" alt="File offset" /></p>

<p>The cell on the third row (<code class="highlighter-rouge">00000020</code>) and last column (<code class="highlighter-rouge">0F</code>) has a <strong>file offset</strong> of <code class="highlighter-rouge">0000002F</code>. <strong>File offset</strong>s are 4 <code class="highlighter-rouge">byte</code>s long, so every time we’ll be looking for an offset or an address we know it’ll be encoded over 4 <code class="highlighter-rouge">byte</code>s.</p>

<h3 id="endianness">Endianness</h3>

<p>Windows is a <a href="https://en.wikipedia.org/wiki/Endianness">little-endian</a> system. This means than the least significant <code class="highlighter-rouge">byte</code>s will appear <strong>before</strong> the most significant ones. So if you were to find the following value: <code class="highlighter-rouge">E0 93 01 00</code>, the address would be <code class="highlighter-rouge">00 01 93 E0</code> - only the <code class="highlighter-rouge">byte</code> order is inverted, not the order within a <code class="highlighter-rouge">byte</code> - which would commonly be written as <code class="highlighter-rouge">0x193E0</code> (<code class="highlighter-rouge">0x</code> denotes a hex notation and the leading <code class="highlighter-rouge">0</code>s are dropped as they are not significant).</p>

<h2 id="figuring-out-the-file-offset-of-addressofentrypoint">Figuring out the file offset of <code class="highlighter-rouge">AddressOfEntryPoint</code></h2>

<p>Now that we know how to read the <code class="highlighter-rouge">hex</code> dump, we’re still left with the same problem: there is no address where it’s supposed to be. This is when I started to browse the Internet trying to understand where <code class="highlighter-rouge">AddressOfEntryPoint</code> was supposed to be located. My quest initially took me to the <a href="https://msdn.microsoft.com/library/windows/desktop/ms680547(v=vs.85).aspx">PE Format specification</a>, after reading it for a while I ended up being more confused than I initially was. The situation was dire and I needed some hope, and hope did appear in the person of Simon Cooper and his brilliant post <a href="https://www.red-gate.com/simple-talk/blogs/anatomy-of-a-net-assembly-pe-headers/">Anatomy of a .NET Assembly – PE Headers</a>. This illustration details the required steps to find the value of the <code class="highlighter-rouge">AddressOfEntryPoint</code>:</p>

<p><img src="/assets/advanced-dotnet-debugging-1/address-of-entry-point.png" alt="AddressOfEntryPoint" /></p>

<p>Thanks to Simon’s detailed write-up I was able to figure out the file offset of the <code class="highlighter-rouge">AddressOfEntryPoint</code> (<code class="highlighter-rouge">0x120</code>), I also found its value: <code class="highlighter-rouge">0x193E0</code>. You can use the below formula to compute the <code class="highlighter-rouge">AddressOfEntryPoint</code> file offset based of the signature file offset:</p>

<blockquote>
  <p>Signature file offset + <code class="highlighter-rouge">0x28</code> = <code class="highlighter-rouge">AddressOfEntryPoint</code> file offset</p>
</blockquote>

<p>If we look back at the screenshot above we can see than the signature file offset was <code class="highlighter-rouge">0xF8</code>. Hence <code class="highlighter-rouge">0xF8</code> + <code class="highlighter-rouge">0x28</code> = <code class="highlighter-rouge">0x120</code>, which is exactly what we found without using the formula.</p>

<h2 id="relative-virtual-address">Relative virtual address</h2>

<p>But we’re now faced with another issue, the address entry point (<code class="highlighter-rouge">0x193E0</code>) resolves to some kind of wasteland:</p>

<p><img src="/assets/advanced-dotnet-debugging-1/wasteland.png" alt="That can't be the entry point!" /></p>

<p>The Portable Executable format has the concept of <strong>Relative Virtual Address</strong> (<code class="highlighter-rouge">RVA</code>) which it defines like this:</p>

<blockquote>
  <p>In an image file, the address of an item after it is loaded into memory, with the base address of the image file subtracted from it.</p>
</blockquote>

<p>As it turns out the <code class="highlighter-rouge">AddressOfEntryPoint</code> is <strong>not</strong> a file offset, it is actually a <code class="highlighter-rouge">RVA</code>.</p>

<p>So we need to <em>load Notepad in memory</em> which equates to running it. But we also need to be able to see the <code class="highlighter-rouge">base address</code> of the image which is not something than the <code class="highlighter-rouge">Task Manager</code> or any other basic tool will be able to provide us. To see this value we need a debugger. Open <code class="highlighter-rouge">Notepad.exe</code> (<code class="highlighter-rouge">%SystemRoot%\notepad.exe</code>) using <a href="https://github.com/gabrielweyer/nuggets/blob/master/windbg/README.md#store">WinDbg Preview</a>:</p>

<p><img src="/assets/advanced-dotnet-debugging-1/open-notepad-windbg-preview.gif" alt="Opening Notepad with WinDbg Preview" /></p>

<p>Type the command <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/lm--list-loaded-modules-">List Loaded Modules</a>:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0:000&gt; lm
start             end                 module name
00007ff6`f92f0000 00007ff6`f9331000   notepad    (deferred)
00007ffd`09ce0000 00007ffd`09f49000   COMCTL32   (deferred)
00007ffd`0abb0000 00007ffd`0ad7c000   urlmon     (deferred)
// Abbreviated</code></pre></figure>

<p>The value we’re interested in is <code class="highlighter-rouge">00007ff6`f92f0000</code>, this is the <code class="highlighter-rouge">start</code> (i.e. the <code class="highlighter-rouge">base address</code>) of the <code class="highlighter-rouge">notepad</code> module.</p>

<p>Armed with this information we’ll be able to look at the instructions located at the <code class="highlighter-rouge">RVA</code> <code class="highlighter-rouge">0x193E0</code> by using the <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/u--unassemble-">Unassemble</a> command:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0:000&gt; u 00007ff6`f92f0000+0x193E0
notepad!WinMainCRTStartup:
00007ff6`f93093e0 4883ec28        sub     rsp,28h
00007ff6`f93093e4 e8c7070000      call    notepad!_security_init_cookie (00007ff6`f9309bb0)
00007ff6`f93093e9 4883c428        add     rsp,28h
00007ff6`f93093ed e902000000      jmp     notepad!__mainCRTStartup (00007ff6`f93093f4)
00007ff6`f93093f2 cc              int     3
00007ff6`f93093f3 cc              int     3
notepad!__mainCRTStartup:
00007ff6`f93093f4 48895c2408      mov     qword ptr [rsp+8],rbx
00007ff6`f93093f9 48897c2410      mov     qword ptr [rsp+10h],rdi</code></pre></figure>

<p>Bingo!</p>

<h2 id="conclusion">Conclusion</h2>

<p>I hope this post clarified how to find the entry point of a native Windows executable.</p>


                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2018/04/07/advanced-dotnet-debugging-1/</guid>
                <description>
                    
                </description>
                <pubDate>Sat, 07 Apr 2018 13:17:02 +1000</pubDate>
                <author></author>
            </item>
        
    
        
            <item>
                <title>Testing anti-patterns #1</title>
                <link>https://gabrielweyer.github.io//2018/03/24/testing-anti-patterns-1/</link>
                <content:encoded>
                    <![CDATA[
                    <p>I often ask candidates to define a good unit test. This is the starting point of a conversation around testing strategies and delivering value. Over the years I’ve heard opinions ranging from <code class="highlighter-rouge">the 100% coverage</code>, passing by <code class="highlighter-rouge">testing is for testers</code>, all the way to <code class="highlighter-rouge">we don't do automated testing</code>. If the notion of a <em>good test</em> can be subjective, it is easier to identify a <strong>bad</strong> test. Bloggers have written about this topic at length but I thought I would try paraphrasing the same content hoping nobody would notice.</p>

<p>I must admit I have written - quite - a few bad tests myself and that’s fine. We all make mistakes, how we handle those mistakes is what help us grow:</p>

<ul>
  <li>It’s important to understand why the mistake happened and put in place measures to prevent the same mistake from happening again</li>
  <li>Equally we should challenge existing practices, they might be there for a good reason but they might instead be there for a <strong>bad</strong> reason</li>
</ul>

<!--more-->

<p>Here are a few anti-patterns I’ve noticed over the years:</p>

<h2 id="ignored-or-commented-test">Ignored or commented test</h2>

<p>Have you ever seen this?</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="na">[Ignore]</span>
<span class="na">[TestMethod]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">Test</span><span class="p">()</span></code></pre></figure>

<p>Luckily only <code class="highlighter-rouge">MSTest</code> allows to ignore a test without providing a message, both <code class="highlighter-rouge">xUnit</code> and <code class="highlighter-rouge">NUnit</code> require the developer to provide a message. What’s worse is that the message of the commit ignoring the test often reads <code class="highlighter-rouge">"fixed" test YOLO LMAO</code> and you’re left wondering what deep philosophical message lies hidden behind those mundane words.</p>

<p>In the case of a <em>commented test</em> the solution is simple: <strong>delete</strong> it. Regarding <em>ignored tests</em>, have a quick read through and run them. If you can’t get them to pass, <strong>delete</strong> them too. Ignored / commented tests will only confuse future developers. You should treat your test code the same way you treat your production code: if a piece of code has no use anymore it should go.</p>

<p><strong>Ask yourself</strong>: why am I ignoring this test, what conditions should be met to enable it again? Then write a <strong>descriptive</strong> ignore message.</p>

<h2 id="non-thread-safe">Non-thread-safe</h2>

<p>The first thing that is wrong with this test is that it’s recording log messages so that they can be asserted at a later stage (see <a href="#asserting-log-messages">below</a> for the log anti-pattern):</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">logger</span>
    <span class="p">.</span><span class="nf">When</span><span class="p">(</span><span class="n">l</span> <span class="p">=&gt;</span> <span class="n">l</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="n">Arg</span><span class="p">.</span><span class="n">Any</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;()))</span>
    <span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="n">ci</span> <span class="p">=&gt;</span> <span class="n">_logs</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">ci</span><span class="p">.</span><span class="n">Arg</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;()));</span></code></pre></figure>

<p>But this was not the only issue with this statement. After making an unrelated change this test failed. I ran it again on its own and it passed, so this test was failing intermittently and I was also getting different <code class="highlighter-rouge">Exception</code> <code class="highlighter-rouge">Type</code>s! The <code class="highlighter-rouge">NullReferenceException</code> wasn’t meaningful but I also got an <code class="highlighter-rouge">IndexOutOfRangeException</code> when adding an element to the <code class="highlighter-rouge">List</code>.</p>

<p>It turned out the code under test was multi-threaded and multiple threads were trying to add to the <code class="highlighter-rouge">List</code> at the same time. The <a href="https://docs.microsoft.com/en-us/dotnet/api/system.collections.generic.list-1?view=netframework-4.7.1#Thread_Safety">.NET API browser</a> makes it clear than <code class="highlighter-rouge">List</code> is not thread-safe:</p>

<blockquote>
  <p>Any instance members are not guaranteed to be thread safe. […] <strong>To ensure thread safety, lock the collection during a read or write operation</strong>.</p>
</blockquote>

<p>In this instance the solution was to lock the <code class="highlighter-rouge">List</code> when adding to it:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">logger</span>
    <span class="p">.</span><span class="nf">When</span><span class="p">(</span><span class="n">l</span> <span class="p">=&gt;</span> <span class="n">l</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="n">Arg</span><span class="p">.</span><span class="n">Any</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;()))</span>
    <span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="n">ci</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">lock</span> <span class="p">(</span><span class="n">_logs</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_logs</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">ci</span><span class="p">.</span><span class="n">Arg</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;());</span>
        <span class="p">}</span>
    <span class="p">});</span></code></pre></figure>

<p><strong>Ask yourself</strong>: most of the code we write is not performance critical, do you need to create multiple threads?</p>

<h2 id="failure-without-enough-context">Failure without enough context</h2>

<p>There is nothing more frustrating than having a build failing on the build server and be faced by this kind of log:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Assert.True() Failure
Expected: True
Actual:   False</code></pre></figure>

<p>From there things only get worse, when you look at the actual assert you discover it’s asserting multiple things at the same time and you’ve no idea which one went wrong:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Assert</span><span class="p">.</span><span class="nf">True</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">A</span> <span class="p">==</span> <span class="n">b</span><span class="p">.</span><span class="n">A</span> <span class="p">&amp;&amp;</span> <span class="n">a</span><span class="p">.</span><span class="n">B</span> <span class="p">==</span> <span class="n">b</span><span class="p">.</span><span class="n">B</span> <span class="p">&amp;&amp;</span> <span class="n">a</span><span class="p">.</span><span class="n">C</span> <span class="p">==</span> <span class="n">b</span><span class="p">.</span><span class="n">C</span><span class="p">);</span></code></pre></figure>

<p>If you need to compare objects you can use an assertion library such as <a href="http://fluentassertions.com/">Fluent Assertions</a> or <a href="https://github.com/shouldly/shouldly">Shouldly</a>.</p>

<p><strong>Ask yourself</strong>: if I make this test break, would I have enough context based on <strong>only</strong> the logs to understand what went wrong?</p>

<h2 id="asserting-log-messages">Asserting log messages</h2>

<p>Please don’t do this:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">logger</span><span class="p">.</span><span class="nf">Received</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="nf">Info</span><span class="p">(</span><span class="s">"Super important log"</span><span class="p">);</span></code></pre></figure>

<p>Logging is an implementation detail, asserting log messages is over-specifying.</p>

<p>On the other hand, if recording that something happened is critical from a business point of view you don’t want to use logging for this purpose as developers should be able to modify logging as they see fit.</p>

<p>Tracking business events can be achieved in different ways:</p>

<ul>
  <li>Via your <code class="highlighter-rouge">APM</code> service, both <a href="https://docs.microsoft.com/en-us/azure/application-insights/app-insights-api-custom-events-metrics#trackevent">Application Insights</a> and <a href="https://docs.newrelic.com/docs/insights/insights-data-sources/custom-data/insert-custom-events-new-relic-apm-agents">New Relic</a> can track custom events</li>
  <li>Via a service bus. Your code could be instrumented to emit messages and any interested service can subscribe to them</li>
</ul>

<p><strong>Ask yourself</strong>: is this the best way of doing this? Read the documentation of the systems you’re currently using, you’ll quite often discover features you had no idea existed.</p>

<h2 id="nullreferenceexception-in-constructor">NullReferenceException in constructor</h2>

<p>Don’t assert than your constructors are throwing a <code class="highlighter-rouge">NullReferenceException</code> when being passed a <code class="highlighter-rouge">null</code>. Your <code class="highlighter-rouge">IoC</code> <code class="highlighter-rouge">container</code> will throw an <code class="highlighter-rouge">Exception</code> anyway when trying to resolve the dependencies.</p>

<p><strong>Ask yourself</strong>: do I need to test third-party libraries?</p>

<h2 id="sanity-check">Sanity check</h2>

<p>Quite often when starting a new project, developers will create a <em>sanity check</em> test. This is a test that <strong>should</strong> pass and if it were to fail it would mean that things are terribly wrong. An example of such a test is this:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Assert</span><span class="p">.</span><span class="nf">True</span><span class="p">(</span><span class="k">true</span><span class="p">);</span></code></pre></figure>

<p>I’ve never seen this kind of test fail. Moreover, this test does not have any value as it doesn’t give me any confidence that the code is behaving the way it is supposed to.</p>

<p><strong>Ask yourself</strong>: Can I break this test by altering the correctness of the production code?</p>


                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2018/03/24/testing-anti-patterns-1/</guid>
                <description>
                    
                </description>
                <pubDate>Sat, 24 Mar 2018 06:36:53 +0000</pubDate>
                <author></author>
            </item>
        
    
        
            <item>
                <title>WinDbg #1 - The static root</title>
                <link>https://gabrielweyer.github.io//2018/03/09/windbg-1-static-root/</link>
                <content:encoded>
                    <![CDATA[
                    <p>This new series is an attempt to improve my <code class="highlighter-rouge">WinDbg</code> skills. The concept is to create faulty applications and troubleshoot the issue using <code class="highlighter-rouge">WinDbg</code> pretending that I have no prior knowledge of the code.</p>

<p>I’ll be using my <a href="https://github.com/gabrielweyer/nuggets/blob/master/windbg/README.md">WinDbg guide</a> as I can never remember the commands! I’m hoping than through those challenges I’ll get to improve the guide. Today’s exercise is inspired by the excellent blog post <a href="https://blogs.microsoft.co.il/sasha/2012/02/07/pinpointing-a-static-gc-root-with-sos/">Pinpointing a Static GC Root with SOS</a>. The post only contains a few commands but I must admit that it took me hours to achieve the same result.<!--more--></p>

<h2 id="the-code">The code</h2>

<p>The application is available on <a href="https://github.com/gabrielweyer/blog-samples/tree/master/windbg-static">GitHub</a>. Clone it, I’ll wait.</p>

<p>It is an <code class="highlighter-rouge">ASP.NET Core 2.0</code> project:</p>

<ul>
  <li>Compile the solution with the <code class="highlighter-rouge">Release</code> <code class="highlighter-rouge">Configuration</code></li>
  <li>Launch the <code class="highlighter-rouge">SampleApi</code> project, it should start on port <code class="highlighter-rouge">5000</code>
    <ul>
      <li>Using <code class="highlighter-rouge">Kestrel</code> will make the next part easier</li>
    </ul>
  </li>
</ul>

<p>Launch <code class="highlighter-rouge">Process Explorer</code>. If you don’t have this gem drop everything you’re doing and <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer">download</a> it now! Click on the <strong>crosshair</strong>, mouse hover the process you want to target and release the button:</p>

<p><img src="/assets/windbg-1/find-process.gif" alt="Find process" /></p>

<p>The <code class="highlighter-rouge">Working Set</code> is sitting just under <code class="highlighter-rouge">44 MB</code>.</p>

<ul>
  <li>Issue <code class="highlighter-rouge">20</code> <code class="highlighter-rouge">GET</code> requests to <code class="highlighter-rouge">http://localhost:5000/feed/me</code></li>
</ul>

<p>If you’re as lazy as me you can leverage <a href="https://docs.microsoft.com/en-us/windows/wsl/install-win10">Windows Subsystem for Linux</a>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="k">for </span>i <span class="k">in</span> <span class="sb">`</span>seq 1 20<span class="sb">`</span><span class="p">;</span> <span class="k">do </span>curl <span class="s2">"http://localhost:5000/feed/me"</span><span class="p">;</span> <span class="k">done</span></code></pre></figure>

<p><img src="/assets/windbg-1/hungry-process.png" alt="Hungry process" /></p>

<p>The <code class="highlighter-rouge">Working Set</code> is now sitting just under <code class="highlighter-rouge">262 MB</code>. That’s an increase of roughly <code class="highlighter-rouge">10 MB</code> per request.</p>

<h2 id="capture-a-full-memory-dump">Capture a full memory dump</h2>

<p>The easiest option in this case is to leverage <code class="highlighter-rouge">Process Explorer</code> as we already have it opened. Right-click on <code class="highlighter-rouge">dotnet.exe</code> and select <code class="highlighter-rouge">Create Full Dump...</code>:</p>

<p><img src="/assets/windbg-1/create-full-dump.png" alt="Create Full Dump" /></p>

<h2 id="install-and-configure-windbg">Install and configure <code class="highlighter-rouge">WinDbg</code></h2>

<p>Follow these instructions:</p>

<ul>
  <li><a href="https://github.com/gabrielweyer/nuggets/blob/master/windbg/README.md#download-and-install-windbg">Download and install WinDbg</a></li>
  <li><a href="https://github.com/gabrielweyer/nuggets/blob/master/windbg/README.md#configure-the-symbols">Configure the symbols</a>:</li>
  <li>Right-click on <code class="highlighter-rouge">dotnet.exe</code> and select <code class="highlighter-rouge">Properties</code></li>
</ul>

<p><img src="/assets/windbg-1/properties.png" alt="Properties" /></p>

<ul>
  <li>Copy the path of the directory where <code class="highlighter-rouge">SampleApi.dll</code> is located (in my case it is <code class="highlighter-rouge">E:/code/me/blog-samples/windbg-static/src/SampleApi/bin/Release/netcoreapp2.0/</code>)</li>
</ul>

<p><img src="/assets/windbg-1/command-line.png" alt="Binaries path" /></p>

<ul>
  <li>Copy the content of this directory into your symbols directory (in my case I configured <code class="highlighter-rouge">sympath</code> to include <code class="highlighter-rouge">C:\symbols\local\</code>):</li>
</ul>

<p><img src="/assets/windbg-1/symbols-directory.png" alt="Symbols directory" /></p>

<ul>
  <li><a href="https://github.com/gabrielweyer/nuggets/blob/master/windbg/README.md#open-a-memory-dump">Open the memory dump</a></li>
  <li><a href="https://github.com/gabrielweyer/nuggets/blob/master/windbg/README.md#net-core">Load the SOS extension</a></li>
</ul>

<p>Now we’re in business!</p>

<h2 id="identifying-the-most-problematic-type--instance">Identifying the most problematic <code class="highlighter-rouge">Type</code> / instance</h2>

<p>We’ll start with the <code class="highlighter-rouge">DumpHeap</code> <a href="https://docs.microsoft.com/en-us/dotnet/framework/tools/sos-dll-sos-debugging-extension#commands">command</a> from the <code class="highlighter-rouge">SOS</code> extension.</p>

<blockquote>
  <p>Displays information about the garbage-collected heap […]. The <code class="highlighter-rouge">-stat</code> option restricts the output to the statistical type summary.</p>
</blockquote>

<p>Instead of listing every single object present in the heap(s), this will group them by <code class="highlighter-rouge">Class Name</code> and provide us with an instance <code class="highlighter-rouge">Count</code> and <code class="highlighter-rouge">TotalSize</code> taken (in <code class="highlighter-rouge">bytes</code>). Let’s run it:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0:000&gt; !dumpheap -stat
Statistics:
              MT    Count    TotalSize Class Name
00007ffb0f6cec68        1           24 System.Collections.Generic.GenericEqualityComparer`1[[System.Int32, System.Private.CoreLib]]
00007ffb0f6cb200        1           24 System.Collections.Generic.GenericEqualityComparer`1[[System.Int64, System.Private.CoreLib]]
00007ffb0f6be130        1           24 System.Collections.Generic.GenericComparer`1[[System.Int32, System.Private.CoreLib]]
// Abbreviated
00007ffb0f632ca8       97       151456 System.Object[]
00007ffac6364330        8       262336 Microsoft.AspNetCore.Server.Kestrel.Transport.Libuv.Internal.LibuvThread+Work[]
00007ffac6158558    30346       971072 Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.DateHeaderValueManager+DateHeaderValues
00007ffac638df58    30345      1942080 System.Collections.Concurrent.ConcurrentDictionary`2+&lt;GetEnumerator&gt;d__38[[System.Int64, System.Private.CoreLib],[Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Infrastructure.FrameConnectionReference, Microsoft.AspNetCore.Server.Kestrel.Core]]
00007ffb0f633050    30475      2148742 System.Byte[]
00007ffb0f667be8    32554      2795084 System.String
00000190177eb6e0     2837     16874148      Free
00007ffb0f634158      158    251802384 System.Int32[]
Total 137415 objects</code></pre></figure>

<p>It looks like we have a winner! There are <code class="highlighter-rouge">158</code> instances of <code class="highlighter-rouge">System.Int32[]</code> for a <code class="highlighter-rouge">TotalSize</code> of <code class="highlighter-rouge">251802384 bytes</code>. As we have only <code class="highlighter-rouge">158</code> instances it’s likely we have a few big instances, let’s list the ones that are bigger than <code class="highlighter-rouge">1000 bytes</code>:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0:000&gt; !dumpheap -type System.Int32[] -min 1000
         Address               MT     Size
0000019019413cf0 00007ffb0f634158     4120
0000019019414d08 00007ffb0f634158     8216
0000019019416d20 00007ffb0f634158    16408
000001901941ad38 00007ffb0f634158    32792
0000019019422d50 00007ffb0f634158    65560
000001941a364df0 00007ffb0f634158 33554456
000001941c364e28 00007ffb0f634158 134217752
0000019439341038 00007ffb0f634158 16777240
0000019449341038 00007ffb0f634158 67108888

Statistics:
              MT    Count    TotalSize Class Name
00007ffb0f634158        9    251785432 System.Int32[]
Total 9 objects</code></pre></figure>

<p>As it turns out one instance is <code class="highlighter-rouge">134217752 bytes</code> which is roughly <code class="highlighter-rouge">134 MB</code>. I suggest we start investigating this one.</p>

<h2 id="determine-what-is-keeping-our-instance-alive">Determine what is keeping our instance alive</h2>

<p>We’ll use another <code class="highlighter-rouge">SOS</code> <a href="https://docs.microsoft.com/en-us/dotnet/framework/tools/sos-dll-sos-debugging-extension#commands">command</a>: <code class="highlighter-rouge">GCRoot</code>.</p>

<blockquote>
  <p>Displays information about references (or roots) to an object at the specified address.</p>
</blockquote>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0:000&gt; !gcroot 000001941c364e28
HandleTable:
    00000190176115f8 (pinned handle)
    -&gt; 0000019419341038 System.Object[]
    -&gt; 0000019019412bf0 System.Collections.Generic.List`1[[System.Int32, System.Private.CoreLib]]
    -&gt; 000001941c364e28 System.Int32[]

Found 1 unique roots (run '!GCRoot -all' to see all roots).</code></pre></figure>

<p>This reads bottom to top, our <code class="highlighter-rouge">Int32[]</code> is referenced by a <code class="highlighter-rouge">List&lt;Int32&gt;</code>. This makes sense as <code class="highlighter-rouge">List&lt;T&gt;</code> is <a href="https://docs.microsoft.com/en-us/dotnet/api/system.collections.generic.list-1?view=netframework-4.7.1#Remarks">using an array</a> internally:</p>

<blockquote>
  <p>The <code class="highlighter-rouge">List&lt;T&gt;</code> <code class="highlighter-rouge">class</code> is the generic equivalent of the <code class="highlighter-rouge">ArrayList</code> <code class="highlighter-rouge">class</code>. It implements the <code class="highlighter-rouge">IList&lt;T&gt;</code> generic <code class="highlighter-rouge">interface</code> by <strong>using an array</strong> whose size is dynamically increased as required.</p>
</blockquote>

<p>In turn this <code class="highlighter-rouge">List&lt;Int32&gt;</code> is referenced by a <code class="highlighter-rouge">System.Object[]</code>. I was hoping to get the name of one of my <code class="highlighter-rouge">class</code> but I’ll have to dig deeper, let’s take a closer look at this array of object.</p>

<p>For this we’ll rely on the <code class="highlighter-rouge">DumpObj</code> <a href="https://docs.microsoft.com/en-us/dotnet/framework/tools/sos-dll-sos-debugging-extension#commands">command</a> from the <code class="highlighter-rouge">SOS</code> extension.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0:000&gt; !do 0000019419341038
Name:        System.Object[]
MethodTable: 00007ffb0f632ca8
EEClass:     00007ffb0edf2a00
Size:        8184(0x1ff8) bytes
Array:       Rank 1, Number of elements 1020, Type CLASS (Print Array)
Fields:
None</code></pre></figure>

<p>According to Sasha Goldshtein <a href="https://blogs.microsoft.co.il/sasha/2012/02/07/pinpointing-a-static-gc-root-with-sos/">post</a> this is how the <code class="highlighter-rouge">CLR</code> stores <code class="highlighter-rouge">static</code> fields:</p>

<blockquote>
  <p>This <code class="highlighter-rouge">object</code> <code class="highlighter-rouge">array</code> is ubiquitous, it would seem that all <code class="highlighter-rouge">static</code> root references stem from it. Indeed (and this is a <code class="highlighter-rouge">CLR</code> implementation detail), <code class="highlighter-rouge">static</code> fields are stored in this array and their retention as far as the <code class="highlighter-rouge">GC</code> is concerned is through it.</p>
</blockquote>

<p>Let’s now determine where in the array is our <code class="highlighter-rouge">List</code> referenced. We’ll use the <code class="highlighter-rouge">Search Memory</code> <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/s--search-memory-">command</a> which is the first <code class="highlighter-rouge">WinDbg</code> command we used today!</p>

<ul>
  <li><code class="highlighter-rouge">-q</code>: we’re looking for a <code class="highlighter-rouge">QWORD</code> (the address is <code class="highlighter-rouge">64 bit</code>)</li>
  <li><code class="highlighter-rouge">L</code>: this is a <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/address-and-address-range-syntax#span-idaddressrangesspanspan-idaddressrangesspanaddress-ranges">Range</a>, we’re starting to search at the address <code class="highlighter-rouge">0000019419341038</code> (the beginning of the array) and we search the whole array (<code class="highlighter-rouge">1ff8</code> is the size of the array as indicated in the previous command output)</li>
  <li><code class="highlighter-rouge">0000019019412bf0</code> is the address of the <code class="highlighter-rouge">List</code></li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0:000&gt; s -q 0000019419341038 L1ff8 0000019019412bf0
00000194`19342830  00000190`19412bf0 00000191`19397798</code></pre></figure>

<p>Sadly the lead stops there. We know this is a <code class="highlighter-rouge">static</code> field but we don’t know which <code class="highlighter-rouge">class</code> it belongs to.</p>

<h2 id="fishing-with-dynamite">Fishing with dynamite</h2>

<p>There is one last thing we can try, we could look for references to <code class="highlighter-rouge">0000019419342830</code> in memory. This section is completely stolen from Sasha’s excellent <a href="https://blogs.microsoft.co.il/sasha/2012/02/07/pinpointing-a-static-gc-root-with-sos/">post</a> as I never did something like this before.</p>

<p>The <code class="highlighter-rouge">SOS</code> <a href="https://docs.microsoft.com/en-us/dotnet/framework/tools/sos-dll-sos-debugging-extension#commands">command</a> <code class="highlighter-rouge">DumpDomain</code> comes in handy:</p>

<blockquote>
  <p>Enumerates each <code class="highlighter-rouge">Assembly</code> object that is loaded within the specified <code class="highlighter-rouge">AppDomain</code> object address.</p>
</blockquote>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0:000&gt; !dumpdomain
--------------------------------------
System Domain:      00007ffb25d15800
LowFrequencyHeap:   00007ffb25d15d80
HighFrequencyHeap:  00007ffb25d15e10
StubHeap:           00007ffb25d15ea0
Stage:              OPEN
Name:               None
--------------------------------------
Shared Domain:      00007ffb25d15220
LowFrequencyHeap:   00007ffb25d15d80
HighFrequencyHeap:  00007ffb25d15e10
StubHeap:           00007ffb25d15ea0
Stage:              OPEN
Name:               None
Assembly:           0000019017796330 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App\2.0.5\System.Private.CoreLib.dll]
ClassLoader:        00000190176b33f0
  Module Name
00007ffb0ed11000            C:\Program Files\dotnet\shared\Microsoft.NETCore.App\2.0.5\System.Private.CoreLib.dll

--------------------------------------
Domain 1:           00000190178511a0
LowFrequencyHeap:   00000190178519a0
HighFrequencyHeap:  0000019017851a30
StubHeap:           0000019017851ac0
Stage:              OPEN
SecurityDescriptor: 0000019017859320
Name:               clrhost
Assembly:           0000019017796330 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App\2.0.5\System.Private.CoreLib.dll]
ClassLoader:        00000190176b33f0
SecurityDescriptor: 000001901774c9a0
  Module Name
00007ffb0ed11000            C:\Program Files\dotnet\shared\Microsoft.NETCore.App\2.0.5\System.Private.CoreLib.dll

Assembly:           0000019017796410 [E:\code\me\blog-samples\windbg-static\src\SampleApi\bin\Release\netcoreapp2.0\SampleApi.dll]
ClassLoader:        0000019017834490
SecurityDescriptor: 00000190177851c0
  Module Name
00007ffac5d04d38            E:\code\me\blog-samples\windbg-static\src\SampleApi\bin\Release\netcoreapp2.0\SampleApi.dll

Assembly:           0000019017786bb0 [C:\Program Files\dotnet\shared\Microsoft.NETCore.App\2.0.5\System.Runtime.dll]
ClassLoader:        0000019017834ee0
SecurityDescriptor: 0000019017784680
  Module Name
00007ffac5d05588            C:\Program Files\dotnet\shared\Microsoft.NETCore.App\2.0.5\System.Runtime.dll

// Abbreviated

Assembly:           0000019019319d90 [C:\Program Files\dotnet\store\x64\netcoreapp2.0\microsoft.aspnetcore.webutilities\2.0.1\lib\netstandard2.0\Microsoft.AspNetCore.WebUtilities.dll]
ClassLoader:        0000019463d80530
SecurityDescriptor: 0000019463dae9c0
  Module Name
00007ffac6549270            C:\Program Files\dotnet\store\x64\netcoreapp2.0\microsoft.aspnetcore.webutilities\2.0.1\lib\netstandard2.0\Microsoft.AspNetCore.WebUtilities.dll</code></pre></figure>

<p><code class="highlighter-rouge">SampleApi.dll</code> is located at <code class="highlighter-rouge">00007ffac5d04d38</code> so it does make sense to start searching at <code class="highlighter-rouge">00007ffa00000000</code>. Remember the <code class="highlighter-rouge">Search Memory</code> command we used above? We’ll put it to good use again:</p>

<ul>
  <li><code class="highlighter-rouge">L</code>: this is a <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/address-and-address-range-syntax#span-idaddressrangesspanspan-idaddressrangesspanaddress-ranges">Range</a>, we’re starting to search at the address <code class="highlighter-rouge">00007ffa00000000</code>
    <ul>
      <li>As we’re searching for a <code class="highlighter-rouge">QWORD</code> the unit is <code class="highlighter-rouge">8 bytes</code> (<code class="highlighter-rouge">64 bit</code>), so we’re looking ahead for <code class="highlighter-rouge">40000000 * 8 = 320 MB</code></li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0:000&gt; s -q 00007ffa00000000 L?00000000`40000000 0000019419342830
00007ffa`c5d05370  00000194`19342830 00000000`00000001</code></pre></figure>

<p>Bingo! Wow I didn’t think it would be that easy. We have a reference! Let’s use the <code class="highlighter-rouge">WinDbg</code> <code class="highlighter-rouge">Unassemble</code> <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/u--unassemble-">command</a> to look at the instructions:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0:000&gt; !u 00007ffa`c5d05370
Unmanaged code
00007ffa`c5d05370 3028            xor     byte ptr [rax],ch
00007ffa`c5d05372 3419            xor     al,19h
00007ffa`c5d05374 94              xchg    eax,esp
00007ffa`c5d05375 0100            add     dword ptr [rax],eax
00007ffa`c5d05377 0001            add     byte ptr [rcx],al
00007ffa`c5d05379 0000            add     byte ptr [rax],al
00007ffa`c5d0537b 0000            add     byte ptr [rax],al
00007ffa`c5d0537d 0000            add     byte ptr [rax],al
00007ffa`c5d0537f 0000            add     byte ptr [rax],al
00007ffa`c5d05381 0000            add     byte ptr [rax],al</code></pre></figure>

<p>Looks like I might have celebrated prematurely. Let’s extend the range:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0:000&gt; s -q 00007ffa00000000 L?00000000`80000000 0000019419342830
00007ffa`c5d05370  00000194`19342830 00000000`00000001</code></pre></figure>

<p>Same result!</p>

<p>Again, this is where Sasha comes to the rescue:</p>

<blockquote>
  <p>The problem is that we might miss unaligned references to that address, which may occur if it is hardcoded into some instruction (e.g. a <code class="highlighter-rouge">MOV</code>). So instead we should be looking for the individual byte sequence, and remember that we are on a little-endian architecture</p>
</blockquote>

<p>The command is the same than the previous one except for two differences:</p>

<ul>
  <li>This time we’re searching for bytes <code class="highlighter-rouge">-b</code></li>
  <li>As we’re on a little-endian architecture, <code class="highlighter-rouge">0000019419342830</code> turn into <code class="highlighter-rouge">30 28 34 19 94 01 00 00</code></li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0:000&gt; s -b 00007ffa00000000 L?00000000`320000000 30 28 34 19 94 01 00 00
00007ffa`c5d05370  30 28 34 19 94 01 00 00-01 00 00 00 00 00 00 00  0(4.............
00007ffa`c63902ac  30 28 34 19 94 01 00 00-48 8b 31 b9 01 00 00 00  0(4.....H.1.....
00007ffa`c6501b6e  30 28 34 19 94 01 00 00-48 8b 55 f8 e8 81 0b 44  0(4.....H.U....D</code></pre></figure>

<p>I’ve already unassembled the first address, let’s look at the two other ones:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0:000&gt; !u 00007ffa`c63902ac
Normal JIT generated code
DynamicClass.lambda_method(System.Runtime.CompilerServices.Closure, System.Object, System.Object[])
Begin 00007ffac6390270, size 71
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c6390270 56              push    rsi
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c6390271 4883ec20        sub     rsp,20h
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c6390275 488bf2          mov     rsi,rdx
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c6390278 4885f6          test    rsi,rsi
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c639027b 7417            je      00007ffa`c6390294
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c639027d 48b910d53cc6fa7f0000 mov rcx,7FFAC63CD510h (MT: SampleApi.Controllers.FeedController)
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c6390287 48390e          cmp     qword ptr [rsi],rcx
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c639028a 7408            je      00007ffa`c6390294
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c639028c e88f225b5f      call    coreclr!JIT_ChkCastClassSpecial (00007ffb`25942520)
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c6390291 488bf0          mov     rsi,rax
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c6390294 8b0e            mov     ecx,dword ptr [rsi]
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c6390296 48b95053d0c5fa7f0000 mov rcx,7FFAC5D05350h
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c63902a0 ba03000000      mov     edx,3
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c63902a5 e8a6515b5f      call    coreclr!JIT_GetSharedNonGCStaticBase_SingleAppDomain (00007ffb`25945450)
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c63902aa 48b93028341994010000 mov rcx,19419342830h
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c63902b4 488b31          mov     rsi,qword ptr [rcx]
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c63902b7 b901000000      mov     ecx,1
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c63902bc ba40420f00      mov     edx,0F4240h
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c63902c1 e8a213adff      call    00007ffa`c5e61668 (System.Linq.Enumerable.Range(Int32, Int32), mdToken: 0000000006000090)
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c63902c6 4c8bc0          mov     r8,rax
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c63902c9 8b5618          mov     edx,dword ptr [rsi+18h]
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c63902cc 488bce          mov     rcx,rsi
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c63902cf 48b8c0d6330ffb7f0000 mov rax,offset System_Private_CoreLib+0x62d6c0 (00007ffb`0f33d6c0)
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c63902d9 4883c420        add     rsp,20h
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c63902dd 5e              pop     rsi
LoadSymbols moduleData.Request FAILED 0x80004005
00007ffa`c63902de 48ffe0          jmp     rax</code></pre></figure>

<p>That’s much nicer, there is a reference to one of my class: <code class="highlighter-rouge">SampleApi.Controllers.FeedController</code>. What about the other address:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0:000&gt; !u 00007ffa`c6501b6e
Normal JIT generated code
SampleApi.Controllers.FeedController..cctor()
Begin 00007ffac6501b40, size 46

E:\code\me\blog-samples\windbg-static\src\SampleApi\Controllers\FeedController.cs @ 10:
00007ffa`c6501b40 55              push    rbp
00007ffa`c6501b41 4883ec30        sub     rsp,30h
00007ffa`c6501b45 488d6c2430      lea     rbp,[rsp+30h]
00007ffa`c6501b4a 33c0            xor     eax,eax
00007ffa`c6501b4c 488945f8        mov     qword ptr [rbp-8],rax
00007ffa`c6501b50 48b9885d670ffb7f0000 mov rcx,offset System_Private_CoreLib+0x965d88 (00007ffb`0f675d88) (MT: System.Collections.Generic.List`1[[System.Int32, System.Private.CoreLib]])
00007ffa`c6501b5a e89127445f      call    coreclr!JIT_TrialAllocSFastMP_InlineGetThread (00007ffb`259442f0)
00007ffa`c6501b5f 488945f8        mov     qword ptr [rbp-8],rax
00007ffa`c6501b63 488b4df8        mov     rcx,qword ptr [rbp-8]
00007ffa`c6501b67 e874cde348      call    System_Private_CoreLib+0x62e8e0 (00007ffb`0f33e8e0) (System.Collections.Generic.List`1[[System.Int32, System.Private.CoreLib]]..ctor(), mdToken: 00000000060038ae)
00007ffa`c6501b6c 48b93028341994010000 mov rcx,19419342830h
00007ffa`c6501b76 488b55f8        mov     rdx,qword ptr [rbp-8]
00007ffa`c6501b7a e8810b445f      call    coreclr!JIT_CheckedWriteBarrier (00007ffb`25942700)
00007ffa`c6501b7f 90              nop
00007ffa`c6501b80 488d6500        lea     rsp,[rbp]
00007ffa`c6501b84 5d              pop     rbp
00007ffa`c6501b85 c3              ret</code></pre></figure>

<p>This goes a step farther as it references the static constructor of <code class="highlighter-rouge">FeedController</code> (<code class="highlighter-rouge">SampleApi.Controllers.FeedController..cctor()</code>). We now have enough information to inspect the code but first let’s take a deeper look at the <code class="highlighter-rouge">FeedController</code> <code class="highlighter-rouge">class</code>.</p>

<p>Let’s use the <code class="highlighter-rouge">SOS</code> <code class="highlighter-rouge">Name2EE</code> <a href="https://docs.microsoft.com/en-us/dotnet/framework/tools/sos-dll-sos-debugging-extension#commands">command</a>.</p>

<blockquote>
  <p>Displays the <code class="highlighter-rouge">MethodTable</code> structure and <code class="highlighter-rouge">EEClass</code> structure for the specified type or method in the specified module. […] This command supports the Windows debugger syntax of <code class="highlighter-rouge">&lt;module&gt;!&lt;type&gt;</code>. The type must be fully qualified.</p>
</blockquote>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0:000&gt; !name2ee SampleApi!SampleApi.Controllers.FeedController
Module:      00007ffac5d04d38
Assembly:    SampleApi.dll
Token:       0000000002000004
MethodTable: 00007ffac63cd510
EEClass:     00007ffac63bf968
Name:        SampleApi.Controllers.FeedController</code></pre></figure>

<p>We’ll use the <code class="highlighter-rouge">SOS</code> <code class="highlighter-rouge">DumpClass</code> <a href="https://docs.microsoft.com/en-us/dotnet/framework/tools/sos-dll-sos-debugging-extension#commands">command</a>.</p>

<blockquote>
  <p>Displays information about the <code class="highlighter-rouge">EEClass</code> structure associated with a type.</p>
</blockquote>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0:000&gt; !DumpClass /d 00007ffac63bf968
Class Name:      SampleApi.Controllers.FeedController
mdToken:         0000000002000004
File:            E:\code\me\blog-samples\windbg-static\src\SampleApi\bin\Release\netcoreapp2.0\SampleApi.dll
Parent Class:    00007ffac63bf868
Module:          00007ffac5d04d38
Method Table:    00007ffac63cd510
Vtable Slots:    90
Total Method Slots:  92
Class Attributes:    100001
Transparency:        Critical
NumInstanceFields:   8
NumStaticFields:     1
              MT    Field   Offset                 Type VT     Attr            Value Name
00007ffac62ec808  400004a        8 ...ControllerContext  0 instance           _controllerContext
00007ffac6061d88  400004b       10 ...lMetadataProvider  0 instance           _metadataProvider
00007ffac6062f20  400004c       18 ...odelBinderFactory  0 instance           _modelBinderFactory
00007ffac6063178  400004d       20 ...ectModelValidator  0 instance           _objectValidator
00007ffac6487758  400004e       28 ...re.Mvc.IUrlHelper  0 instance           _url
00007ffac6487630  4000018       30 ...empDataDictionary  0 instance           _tempData
0000000000000000  4000019       38 ...l.DynamicViewData  0 instance           _viewBag
00007ffac6487480  400001a       40 ...iewDataDictionary  0 instance           _viewData
00007ffb0f675d88  4000002        8 ...Private.CoreLib]]  0   static 0000019019412bf0 MemoryHog</code></pre></figure>

<p>So, it turns out the <code class="highlighter-rouge">FeedController</code> has a <code class="highlighter-rouge">static</code> field named <code class="highlighter-rouge">MemoryHog</code>. Probably not my <a href="https://github.com/gabrielweyer/blog-samples/blob/4d434b594d7cab48f50bc12140fd9b7fd5f89977/windbg-static/src/SampleApi/Controllers/FeedController.cs#L10">finest</a> piece of <a href="https://github.com/gabrielweyer/blog-samples/blob/4d434b594d7cab48f50bc12140fd9b7fd5f89977/windbg-static/src/SampleApi/Controllers/FeedController.cs#L15">coding</a> to be honest.</p>

<h2 id="conclusion">Conclusion</h2>

<p>I learned how to trace back a <code class="highlighter-rouge">static</code> field to a <code class="highlighter-rouge">class</code>. I’m sure this will come in handy later.</p>

<p>I might have made some mistakes around <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/address-and-address-range-syntax#span-idaddressrangesspanspan-idaddressrangesspanaddress-ranges">Ranges</a> as this is an area I’m still unfamiliar with but it shouldn’t prevent you from achieving the same result.</p>

<p>Until next time!</p>


                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2018/03/09/windbg-1-static-root/</guid>
                <description>
                    
                </description>
                <pubDate>Fri, 09 Mar 2018 21:51:53 +0000</pubDate>
                <author></author>
            </item>
        
    
        
            <item>
                <title>Beanstalk Seeder</title>
                <link>https://gabrielweyer.github.io//2018/02/23/beanstalk-seeder/</link>
                <content:encoded>
                    <![CDATA[
                    <p><code class="highlighter-rouge">Elastic Beanstalk</code> is a great platform, it offers both a <code class="highlighter-rouge">Web</code> tier and a <code class="highlighter-rouge">Worker</code> tier. I recently wrote about <a href="/2018/01/28/simple-routing-elastic-beanstalk-worker/">Simple Routing</a> one of my library that allows you to route a <code class="highlighter-rouge">SQS</code> message to a specific endpoint on the <code class="highlighter-rouge">Worker</code>.</p>

<p>While <code class="highlighter-rouge">Beanstalk</code> works great once it’s deployed to <code class="highlighter-rouge">AWS</code> there is no easy way to run it locally. As soon as you want to execute an end-to-end flow involving both the <code class="highlighter-rouge">Web</code> and the <code class="highlighter-rouge">Worker</code> you need to manually <code class="highlighter-rouge">POST</code> requests to the <code class="highlighter-rouge">Worker</code> using <a href="https://www.getpostman.com/">Postman</a> which is cumbersome and error-prone.</p>

<p>As it core all the <a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features-managing-env-tiers.html">SQS daemon</a> does is dequeue messages from a <code class="highlighter-rouge">SQS</code> queue and <code class="highlighter-rouge">POST</code> it to a specified endpoint. With this goal in mind I wrote <a href="https://github.com/gabrielweyer/beanstalk-seeder">Beanstalk Seeder</a>.<!--more--></p>

<p>I had the following objectives:</p>

<ul>
  <li>Users should be able to get up and running quickly</li>
  <li>Meaningful logging</li>
  <li>Transform the <code class="highlighter-rouge">SQS</code> <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-message-attributes.html">message attributes</a> into HTTP headers (in order to support <a href="https://github.com/gabrielweyer/simple-routing">Simple Routing</a>)</li>
</ul>

<h2 id="get-up-and-running-quickly">Get up and running quickly</h2>

<p>You can get <code class="highlighter-rouge">Beanstalk Seeder</code> from <a href="https://github.com/gabrielweyer/beanstalk-seeder/releases">GitHub releases</a>. Download the archive and extract it somewhere.</p>

<p><code class="highlighter-rouge">Beanstalk Seeder</code>’s <a href="https://github.com/gabrielweyer/beanstalk-seeder#configuration">configuration</a> is detailed in the <code class="highlighter-rouge">README</code>. All you need is a <code class="highlighter-rouge">iAM</code> user, the <code class="highlighter-rouge">Worker</code> <code class="highlighter-rouge">URI</code> and the <code class="highlighter-rouge">SQS</code> queue <code class="highlighter-rouge">URI.</code></p>

<h2 id="meaningful-logging">Meaningful logging</h2>

<p>When running a third-party tool, it’s critical to get meaningful logging as the binary is a black-box for the end user. I use <a href="https://nblumhardt.com/2016/06/structured-logging-concepts-in-net-series-1/#what-is-structured-logging">structured logging</a> in order to make querying the log events a breeze. My logging framework of choice is <a href="https://blog.getseq.net/serilog-tutorial/">Serilog</a>.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">loggerConfiguration</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">LoggerConfiguration</span><span class="p">()</span>
    <span class="p">.</span><span class="n">Destructure</span><span class="p">.</span><span class="n">ByTransforming</span><span class="p">&lt;</span><span class="n">MessageAttributeValue</span><span class="p">&gt;(</span><span class="n">Destructure</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Destructure</span><span class="p">.</span><span class="n">ByTransforming</span><span class="p">&lt;</span><span class="n">Message</span><span class="p">&gt;(</span><span class="n">Destructure</span><span class="p">)</span>
    <span class="p">.</span><span class="n">MinimumLevel</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="n">serilogLevel</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Enrich</span><span class="p">.</span><span class="nf">WithDemystifiedStackTraces</span><span class="p">()</span>
    <span class="p">.</span><span class="n">Enrich</span><span class="p">.</span><span class="nf">FromLogContext</span><span class="p">()</span>
    <span class="p">.</span><span class="n">WriteTo</span><span class="p">.</span><span class="nf">Console</span><span class="p">(</span><span class="n">serilogLevel</span><span class="p">);</span></code></pre></figure>

<p>The previous snippet highlights only a few of the <code class="highlighter-rouge">Serilog</code> features.</p>

<h3 id="the-structure-capturing-operator">The structure-capturing operator</h3>

<p><code class="highlighter-rouge">MessageAttributeValue</code> and <code class="highlighter-rouge">Message</code> are both defined in the <code class="highlighter-rouge">awssdk.sqs</code> <code class="highlighter-rouge">NuGet</code> package. I’m interested in logging only some of their properties, <code class="highlighter-rouge">Serilog</code> has the ability to capture object via the <a href="https://nblumhardt.com/2016/08/serialized-data-structured-logging-concepts-in-net-6/#capturing-objects">structure-capturing operator</a>.</p>

<h3 id="enrichment">Enrichment</h3>

<blockquote>
  <p>Enrichment is the act of adding additional properties to events, other than the ones originating from the message template.</p>
</blockquote>

<p><code class="highlighter-rouge">Serilog</code> supports <a href="https://blog.getseq.net/serilog-tutorial/#enrichingwithambientcontext">ambient context</a>. I’m also using the excellent <a href="https://github.com/benaadams/Ben.Demystifier">Ben.Demystifier</a> for getting nicer stack traces.</p>

<h3 id="sinks">Sinks</h3>

<p>By default, <code class="highlighter-rouge">Serilog</code> does not log anywhere. In order to record events you’ll need to configure one or more <code class="highlighter-rouge">Sink</code>s. In this case I’m writing to the console but they are <a href="https://github.com/serilog/serilog/wiki/Provided-Sinks">many other</a> <code class="highlighter-rouge">Sink</code>s available.</p>

<h3 id="result">Result</h3>

<p><img src="/assets/beanstalk-seeder/events.png" alt="HTTP Path" /></p>

<p>I hope the recorded events are descriptive enough so that an end user know what’s happening:</p>

<ul>
  <li>First I display the settings used, this is important as they could come from the <code class="highlighter-rouge">appsettings.json</code>, environment variables or even the <a href="https://docs.microsoft.com/en-us/aspnet/core/security/app-secrets?tabs=visual-studio#secret-manager">user secrets</a> if the environment is <code class="highlighter-rouge">Development</code>.</li>
  <li>Then using the <code class="highlighter-rouge">structure-capturing operator</code> I log the relevant <code class="highlighter-rouge">SQS</code> message properties.</li>
  <li>Instead of logging the complete HTTP request I log the content of the body and the relevant headers.</li>
  <li>When deleting the message, I log the <code class="highlighter-rouge">ReceiptHandle</code>, this is the value used to delete a message and the user can correlate it to what was displayed above.</li>
  <li>Finally, rather than not displaying anything when there are no messages in the queue I inform the user that’s the case and how long I’ll wait before retrying.</li>
</ul>

<h2 id="interestings-bits">Interestings bits</h2>

<p>I’m using a <a href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.cancellationtokensource?view=netcore-2.0">CancellationTokenSource</a> so that the user can stop the message pump at any time (relying on <a href="https://docs.microsoft.com/en-us/dotnet/api/system.console.cancelkeypress?view=netcore-2.0">Console.CancelKeyPress</a>).</p>

<p>The <a href="https://github.com/gabrielweyer/beanstalk-seeder/blob/ca47d6f84fe748915a22de63b23a34ef735a88ae/src/BeanstalkSeeder/Services/MessagePump.cs">MessagePump</a> <code class="highlighter-rouge">class</code> is the only <code class="highlighter-rouge">class</code> with some logic. I wrote some <a href="https://github.com/gabrielweyer/beanstalk-seeder/blob/ca47d6f84fe748915a22de63b23a34ef735a88ae/tests/BeanstalkSeederTests/MessagePumpTests.cs">tests</a> around the cancellation token, the transformation of <code class="highlighter-rouge">SQS</code> message attributes into HTTP headers and the back-off when no messages are available in the queue.</p>

<h2 id="conclusion">Conclusion</h2>

<p>I hope you’ll find <a href="https://github.com/gabrielweyer/beanstalk-seeder">Beanstalk Seeder</a> as useful as I did, combined with <a href="https://github.com/gabrielweyer/simple-routing">Simple Routing</a> it simplified and streamlined my <code class="highlighter-rouge">Elastic Beanstalk</code> development.</p>

<p>I also wanted to point out that <code class="highlighter-rouge">Beanstalk Seeder</code> is platform agnostic. It doesn’t matter if you’re developing using <code class="highlighter-rouge">Node.js</code>, <code class="highlighter-rouge">Go</code> or any other of the <a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/concepts.platforms.html">Elastic Beanstalk supported platforms</a>, all you need to do is install the latest <a href="https://www.microsoft.com/net/download/windows">.NET Core runtime</a> (available on <code class="highlighter-rouge">Windows</code>, <code class="highlighter-rouge">macOS</code> and <code class="highlighter-rouge">Linux</code>).</p>


                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2018/02/23/beanstalk-seeder/</guid>
                <description>
                    
                </description>
                <pubDate>Fri, 23 Feb 2018 23:40:46 +0000</pubDate>
                <author></author>
            </item>
        
    
        
            <item>
                <title>Singleton HTTP Client</title>
                <link>https://gabrielweyer.github.io//2018/02/08/singleton-http-client/</link>
                <content:encoded>
                    <![CDATA[
                    <p>Even though the <code class="highlighter-rouge">class</code> <code class="highlighter-rouge">HttpClient</code> implements <code class="highlighter-rouge">IDisposable</code> it is supposed to be used as a singleton as stated in the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.http.httpclient?view=netcore-2.0#Remarks">API reference</a>:</p>

<blockquote>
  <p><code class="highlighter-rouge">HttpClient</code> is intended to be instantiated once and re-used throughout the life of an application. Instantiating an <code class="highlighter-rouge">HttpClient</code> class for every request will exhaust the number of sockets available under heavy loads. This will result in <code class="highlighter-rouge">SocketException</code> errors.</p>
</blockquote>

<p>The accepted best practice is to have one <code class="highlighter-rouge">HttpClient</code> per HTTP endpoint you’re interacting with. This will not only yield better performance it also allows to encapsulate endpoint specific logic (such as setting headers).</p>

<p>Now the question is: how do you configure your <code class="highlighter-rouge">IoC</code> container to resolve the expected <code class="highlighter-rouge">HttpClient</code> instance? This used to require a cumbersome registration but <code class="highlighter-rouge">.NET Core 2.1</code> will ship with the <a href="https://github.com/aspnet/HttpClientFactory">HttpClientFactory</a> making our life much easier.<!--more--></p>

<h2 id="httpclientfactory"><code class="highlighter-rouge">HttpClientFactory</code></h2>

<p><a href="https://www.stevejgordon.co.uk/">Steve Gordon</a> has an excellent <a href="https://www.stevejgordon.co.uk/httpclientfactory-named-typed-clients-aspnetcore">post</a> explaining what is <code class="highlighter-rouge">HttpClientFactory</code> and how it works.</p>

<p><code class="highlighter-rouge">HttpClientFactory</code> aims to provide the following improvements:</p>

<ul>
  <li>Alleviate sockets exhaustion by reusing connection when possible</li>
  <li>Alleviate stale <code class="highlighter-rouge">DNS</code> records (by default <code class="highlighter-rouge">HttpClient</code> caches <code class="highlighter-rouge">DNS</code> records for its lifetime)</li>
  <li>Easily resolve an <code class="highlighter-rouge">HttpClient</code> instance linked to a specific HTTP endpoint</li>
</ul>

<p>What if you can’t use <code class="highlighter-rouge">.NET Core</code> or can’t update? Fear not, we can achieve tomorrow’s dream with today’s tools (most of it anyway).</p>

<h2 id="associate-an-httpclient-instance-with-the-service-using-it">Associate an <code class="highlighter-rouge">HttpClient</code> instance with the service using it</h2>

<p><code class="highlighter-rouge">HttpClient</code> instances communicating with a specific HTTP endpoint tend to have dedicated settings such as an <code class="highlighter-rouge">Authorization</code> header, default request headers (<code class="highlighter-rouge">Accept</code> for example), maybe a <code class="highlighter-rouge">HMAC</code>… I tend to encapsulate those settings in a <code class="highlighter-rouge">class</code> to decouple the settings’s source from the consummer.</p>

<p>Let’s imagine that we’re integrating with a fictitious company called <em>Contoso</em>. The integration takes place via an HTTP API and our contact at Contoso gave us a bearer token that needs to be set on the <code class="highlighter-rouge">Authorization</code> header.</p>

<p>The first step is to create a <code class="highlighter-rouge">POCO</code> modelizing the settings:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">ContosoSettings</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">Uri</span> <span class="n">BaseAddress</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">BearerToken</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p><code class="highlighter-rouge">HttpClient</code> makes writing tests harder. Developers tend to derive from <code class="highlighter-rouge">HttpMessageHandler</code> and provide an implementation allowing them to assert the requests issued by the <code class="highlighter-rouge">HttpClient</code>. I prefer to introduce an interface called <code class="highlighter-rouge">IHttpClient</code> exposing a single method to handle <code class="highlighter-rouge">HTTP</code> traffic:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">interface</span> <span class="nc">IHttpClient</span>
<span class="p">{</span>
    <span class="n">Task</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span> <span class="nf">SendAsync</span><span class="p">(</span><span class="n">HttpRequestMessage</span> <span class="n">request</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>We then implement the <code class="highlighter-rouge">ContosoHttpClient</code> that will be dedicated to communicating with the <code class="highlighter-rouge">Contoso</code> API:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">ContosoHttpClient</span> <span class="p">:</span> <span class="n">HttpClient</span><span class="p">,</span> <span class="n">IHttpClient</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">ContosoHttpClient</span><span class="p">(</span><span class="n">ContosoSettings</span> <span class="n">settings</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BaseAddress</span> <span class="p">=</span> <span class="n">settings</span><span class="p">.</span><span class="n">BaseAddress</span><span class="p">;</span>
        <span class="n">DefaultRequestHeaders</span><span class="p">.</span><span class="n">Authorization</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AuthenticationHeaderValue</span><span class="p">(</span><span class="s">"Bearer"</span><span class="p">,</span> <span class="n">settings</span><span class="p">.</span><span class="n">BearerToken</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>And finally we registers the <code class="highlighter-rouge">Type</code>s in the <code class="highlighter-rouge">IoC</code> container:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">const</span> <span class="kt">string</span> <span class="n">contosoHttpClientAutofacKeyName</span> <span class="p">=</span> <span class="s">"ContosoHttpClient"</span><span class="p">;</span>

<span class="n">builder</span><span class="p">.</span><span class="n">RegisterType</span><span class="p">&lt;</span><span class="n">ContosoHttpClient</span><span class="p">&gt;()</span>
    <span class="p">.</span><span class="nf">Named</span><span class="p">(</span><span class="n">contosoHttpClientAutofacKeyName</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">IHttpClient</span><span class="p">))</span>
    <span class="p">.</span><span class="nf">SingleInstance</span><span class="p">();</span>

<span class="n">builder</span><span class="p">.</span><span class="n">RegisterType</span><span class="p">&lt;</span><span class="n">ContosoClient</span><span class="p">&gt;()</span>
    <span class="p">.</span><span class="nf">WithParameter</span><span class="p">(</span><span class="k">new</span> <span class="nf">ResolvedParameter</span><span class="p">(</span>
        <span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">pi</span><span class="p">.</span><span class="n">ParameterType</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">IHttpClient</span><span class="p">),</span>
        <span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">ctx</span><span class="p">.</span><span class="n">ResolveNamed</span><span class="p">&lt;</span><span class="n">IHttpClient</span><span class="p">&gt;(</span><span class="n">ContosoHttpClientAutofacKeyName</span><span class="p">)))</span>
    <span class="p">.</span><span class="nf">AsImplementedInterfaces</span><span class="p">().</span><span class="nf">InstancePerRequest</span><span class="p">();</span>

<span class="c1">// Abbreviated: resolve and register ContosoSettings (from Web.config, appsettings.json, CSV, volumen...)</span></code></pre></figure>

<p>This snippet is using <code class="highlighter-rouge">Autofac</code> <a href="http://autofaccn.readthedocs.io/en/latest/advanced/keyed-services.html#named-services">named service</a>. Using a <code class="highlighter-rouge">named service</code> this way has several benefits:</p>

<ul>
  <li>If someone registered another <code class="highlighter-rouge">IHttpClient</code> that is supposed to be used everywhere else we will not override the registration for all the other services while still retrieving an instance of <code class="highlighter-rouge">ContosoHttpClient</code> when resolving <code class="highlighter-rouge">IContosoClient</code>.</li>
  <li>The <code class="highlighter-rouge">named service</code> is an implementation details that only the <code class="highlighter-rouge">IoC</code> container knows about.</li>
</ul>

<h2 id="solve-stale-dns-records">Solve stale DNS records</h2>

<p>Let’s say you’re interacting with an API hosted at <code class="highlighter-rouge">https://api.contoso.com</code>, <code class="highlighter-rouge">HttpClient</code> will first have to resolve the domain name to an <code class="highlighter-rouge">IP</code> thanks to a <code class="highlighter-rouge">DNS</code> server. But what happens if the <code class="highlighter-rouge">DNS</code> record is updated and the domain name now resolves to another <code class="highlighter-rouge">IP</code>? If you are using a transient <code class="highlighter-rouge">HttpClient</code> you’ll be fine but if you’re using a singleton instance (as you should) <code class="highlighter-rouge">Exception</code>s will start to shoot up in your monitoring system. Should we stop calling APIs, or maybe rewrite everything in <code class="highlighter-rouge">Go</code>?</p>

<p>The <a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.servicepoint.connectionleasetimeout?view=netframework-4.7.1#System_Net_ServicePoint_ConnectionLeaseTimeout">ConnectionLeaseTimeout</a> property can solve this situation nicely for us:</p>

<blockquote>
  <p>A <code class="highlighter-rouge">Int32</code> that specifies the number of <strong>milliseconds</strong> that an active <code class="highlighter-rouge">ServicePoint</code> connection remains open. <strong>The default is <code class="highlighter-rouge">-1</code>, which allows an active <code class="highlighter-rouge">ServicePoint</code> connection to stay connected indefinitely</strong>. Set this property to <code class="highlighter-rouge">0</code> to force <code class="highlighter-rouge">ServicePoint</code> connections to close after servicing a request.</p>
</blockquote>

<p>This is how you set it:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">apiUri</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="s">"https://api.contoso.com"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">sp</span> <span class="p">=</span> <span class="n">ServicePointManager</span><span class="p">.</span><span class="nf">FindServicePoint</span><span class="p">(</span><span class="n">apiUri</span><span class="p">);</span>
<span class="n">sp</span><span class="p">.</span><span class="n">ConnectionLeaseTimeout</span> <span class="p">=</span> <span class="m">60</span><span class="p">*</span><span class="m">1000</span><span class="p">;</span></code></pre></figure>

<p>In the previous snippet I’m keeping the connection opened for a minute which seems like a good trade-off.</p>

<h2 id="conclusion">Conclusion</h2>

<p>I haven’t looked at the implementation of <code class="highlighter-rouge">HttpClientFactory</code> yet but I suspect the end result will be fairly similar to what I demonstrated above. If you still have doubts about using a singleton <code class="highlighter-rouge">HttpClient</code> I recommend you to perf test it. At a previous customer I developped an API that was calling other HTTP endpoints, I increased the throughput by a factor of <code class="highlighter-rouge">10</code> by changing a single thing: I made the <code class="highlighter-rouge">HttpClient</code> a singleton rather than a per-request scope.</p>


                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2018/02/08/singleton-http-client/</guid>
                <description>
                    
                </description>
                <pubDate>Thu, 08 Feb 2018 20:34:06 +0000</pubDate>
                <author></author>
            </item>
        
    
        
            <item>
                <title>Simple Routing for Elastic Beanstalk Worker tier</title>
                <link>https://gabrielweyer.github.io//2018/01/28/simple-routing-elastic-beanstalk-worker/</link>
                <content:encoded>
                    <![CDATA[
                    <p><code class="highlighter-rouge">Elastic Beanstalk</code> offers both a <code class="highlighter-rouge">Web</code> tier and a <code class="highlighter-rouge">Worker</code> tier. This allows developers to build reasonably complex applications without having to maintain moving pieces. Offloading heavy-duty workloads to the worker in order to keep the web tier responsive is as easy as putting a message on a queue.</p>

<p><img src="/assets/simple-routing-elastic-beanstalk-worker/http-path.png" alt="HTTP Path" /></p>

<p>One annoyance that I have with <code class="highlighter-rouge">Beanstalk</code> is that there is no way to direct a message to a specific endpoint, hence leaving a single endpoint the responsibility of distributing the messages to all their handlers and potentially leading to brittle code. But it doesn’t have to be that way.<!--more--></p>

<h2 id="implementation">Implementation</h2>

<p><code class="highlighter-rouge">SQS</code> messages have <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-message-attributes.html">attributes</a>, attributes can be set by the sender and are read by the receiver. The idea is to use a known attribute to attach routing metadata to the message.</p>

<h3 id="constants">Constants</h3>

<p>Constants are the base of any decently built <code class="highlighter-rouge">C#</code> application. I did not want to depart from to this rule and hence added some constants:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">RoutingConstants</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">HeaderName</span> <span class="p">=</span> <span class="s">"Task"</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">HeaderType</span> <span class="p">=</span> <span class="s">"String"</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>These constansts will be used to add routing metadata to the <code class="highlighter-rouge">SQS</code> message.</p>

<p>We can then define our routes via some more constants:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">WorkerConstants</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">DoSomeWorkTaskName</span> <span class="p">=</span> <span class="s">"do-some-work"</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">DoSomeOtherWorkTaskName</span> <span class="p">=</span> <span class="s">"do-some-other-work"</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><strong>Note</strong>: those two <code class="highlighter-rouge">class</code> will have to be referenced by the sender and the <code class="highlighter-rouge">Worker</code>.</p>

<h3 id="sending-the-message">Sending the message</h3>

<p>The sender will most likely be the <code class="highlighter-rouge">Web</code> tier but it could be any system being able to send a message to a <code class="highlighter-rouge">SQS</code> queue.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">sendMessageRequest</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SendMessageRequest</span><span class="p">();</span>
<span class="c1">// Abbreviated: set properties on sendMessageRequest, such as the MessageBody and the QueueUrl</span>

<span class="c1">// We're using RoutingConstants.HeaderName as the MessageAttribute key</span>
<span class="c1">// and WorkerConstants.DoSomeWorkTaskName as the MessageAttribute value</span>
<span class="n">sendMessageRequest</span><span class="p">.</span><span class="n">MessageAttributes</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span>
    <span class="n">RoutingConstants</span><span class="p">.</span><span class="n">HeaderName</span><span class="p">,</span>
    <span class="k">new</span> <span class="n">MessageAttributeValue</span> <span class="p">{</span><span class="n">StringValue</span> <span class="p">=</span> <span class="n">WorkerConstants</span><span class="p">.</span><span class="n">DoSomeWorkTaskName</span><span class="p">,</span> <span class="n">DataType</span> <span class="p">=</span> <span class="n">RoutingConstants</span><span class="p">.</span><span class="n">HeaderType</span><span class="p">});</span>

<span class="c1">// Abbreviated: send the message</span></code></pre></figure>

<h3 id="middleware">Middleware</h3>

<p>In the <code class="highlighter-rouge">Worker</code>, the routing is implemented via a <code class="highlighter-rouge">Middleware</code>:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">HeaderRoutingMiddleware</span>
<span class="p">{</span>
    <span class="c1">// Elastic Beanstalk prefixes the SQS messages properties' name with "X-Aws-Sqsd-Attr-"</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">TaskHeaderName</span> <span class="p">=</span> <span class="s">$"X-Aws-Sqsd-Attr-</span><span class="p">{</span><span class="n">RoutingConstants</span><span class="p">.</span><span class="n">HeaderName</span><span class="p">}</span><span class="s">"</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">Task</span> <span class="nf">Invoke</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// We get the value of the routing header</span>
        <span class="n">StringValues</span> <span class="n">task</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Headers</span><span class="p">[</span><span class="n">TaskHeaderName</span><span class="p">];</span>

        <span class="c1">// And set it as the path</span>
        <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Path</span> <span class="p">=</span> <span class="s">$"/</span><span class="p">{</span><span class="n">task</span><span class="p">.</span><span class="nf">Single</span><span class="p">()}</span><span class="s">"</span><span class="p">;</span>

        <span class="k">return</span> <span class="nf">_next</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p><strong>Note</strong>: don’t forget to add <code class="highlighter-rouge">HeaderRoutingMiddleware</code> to the <code class="highlighter-rouge">IApplicationBuilder</code>.</p>

<h3 id="controller">Controller</h3>

<p>The last piece of the puzzle is defining the expected route on the <code class="highlighter-rouge">Controller</code>:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="c1">// This is important, we do not want a prefix in front of the action's route</span>
<span class="na">[Route("")]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">SomeController</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
  <span class="c1">// The route has to match the value given to the MessageAttribute</span>
  <span class="p">[</span><span class="nf">HttpPost</span><span class="p">(</span><span class="n">WorkerConstants</span><span class="p">.</span><span class="n">DoSomeWorkTaskName</span><span class="p">)]</span>
  <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IActionResult</span><span class="p">&gt;</span> <span class="nf">SomeMethod</span><span class="p">(</span><span class="n">SomeModel</span> <span class="n">model</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="c1">// Abbreviated for clarity</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<h2 id="simple-routing">Simple routing</h2>

<p>I used <code class="highlighter-rouge">Simple Routing</code> in production over the last few months and am now confident that it does what it’s supposed to do. This is why I decided to release it under a <code class="highlighter-rouge">MIT</code> license to allow others to benefit from my work.</p>

<p><code class="highlighter-rouge">Simple Routing</code> is available:</p>

<ul>
  <li>On <code class="highlighter-rouge">NuGet</code> as the package <a href="https://www.nuget.org/packages/BeanstalkWorker.SimpleRouting/">BeanstalkWorker.SimpleRouting</a></li>
  <li>A <code class="highlighter-rouge">GitHub</code> <a href="https://github.com/gabrielweyer/simple-routing/releases">release</a></li>
  <li>As <a href="https://github.com/gabrielweyer/simple-routing">source</a> on <code class="highlighter-rouge">Github</code>
    <ul>
      <li>The implementation is so simple that you can just copy the classes into your own solution if that works better for you</li>
    </ul>
  </li>
</ul>

<h3 id="demo">Demo</h3>

<p>The <code class="highlighter-rouge">Simple Routing</code> solution contains a <code class="highlighter-rouge">SampleWeb</code> app, you can either:</p>

<ul>
  <li>Send “work” - <code class="highlighter-rouge">Send/Work</code></li>
  <li>Send “nothing” - <code class="highlighter-rouge">Send/Nothing</code></li>
</ul>

<h4 id="send-messages">Send messages</h4>

<figure class="highlight"><pre><code class="language-text" data-lang="text">GET http://localhost:5000/Send/Work HTTP/1.1
Host: localhost:5000</code></pre></figure>

<p><img src="/assets/simple-routing-elastic-beanstalk-worker/web-send-work.png" alt="Send Work" /></p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">GET http://localhost:5000/Send/Nothing HTTP/1.1
Host: localhost:5000</code></pre></figure>

<p><img src="/assets/simple-routing-elastic-beanstalk-worker/web-send-nothing.png" alt="Send Nothing" /></p>

<h4 id="peek-at-the-messages">Peek at the messages</h4>

<p>Now let’s look at the messages in the <code class="highlighter-rouge">SQS</code> queue:</p>

<ul>
  <li>The <code class="highlighter-rouge">Work</code> message</li>
</ul>

<p><img src="/assets/simple-routing-elastic-beanstalk-worker/message-work-body.png" alt="Work Message Body" /></p>

<p><img src="/assets/simple-routing-elastic-beanstalk-worker/message-work-attributes.png" alt="Work Message Attributes" /></p>

<ul>
  <li>The <code class="highlighter-rouge">Nothing</code> message</li>
</ul>

<p><img src="/assets/simple-routing-elastic-beanstalk-worker/message-nothing-body.png" alt="Nothing Message Body" /></p>

<p><img src="/assets/simple-routing-elastic-beanstalk-worker/message-nothing-attributes.png" alt="Nothing Message Attributes" /></p>

<h4 id="handle-the-messages">Handle the messages</h4>

<p>Launch the <code class="highlighter-rouge">SampleWorker</code> app. When running in <code class="highlighter-rouge">ElasticBeanstalk</code> the <a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features-managing-env-tiers.html">Sqsd daemon</a> reads <code class="highlighter-rouge">SQS</code> messages from the <code class="highlighter-rouge">SQS</code> queue and <code class="highlighter-rouge">POST</code> the content to your <code class="highlighter-rouge">Worker</code>. But we’re running the <code class="highlighter-rouge">Worker</code> on our machine and the <code class="highlighter-rouge">Sqsd daemon</code> is not available. This is why I wrote <code class="highlighter-rouge">Beanstalk Seeder</code>.</p>

<blockquote>
  <p><a href="https://github.com/gabrielweyer/beanstalk-seeder">Beanstalk Seeder</a> emulates the <code class="highlighter-rouge">SQS Daemon</code> surrounding an <code class="highlighter-rouge">Elastic Beanstalk</code> <code class="highlighter-rouge">Worker Tier</code> so that you can replicate the interaction between a <code class="highlighter-rouge">Web Tier</code> and a <code class="highlighter-rouge">Worker Tier</code> on your machine.</p>
</blockquote>

<h5 id="handling-the-work-message">Handling the <code class="highlighter-rouge">Work</code> message</h5>

<ul>
  <li><code class="highlighter-rouge">Beanstalk Seeder</code></li>
</ul>

<p><img src="/assets/simple-routing-elastic-beanstalk-worker/beanstalk-seeder-work.png" alt="Work Message Beanstalk Seeder" /></p>

<ul>
  <li><code class="highlighter-rouge">Worker</code></li>
</ul>

<p><img src="/assets/simple-routing-elastic-beanstalk-worker/worker-work.png" alt="Work Message Worker" /></p>

<h5 id="handling-the-nothing-message">Handling the <code class="highlighter-rouge">Nothing</code> message</h5>

<ul>
  <li><code class="highlighter-rouge">Beanstalk Seeder</code></li>
</ul>

<p><img src="/assets/simple-routing-elastic-beanstalk-worker/beanstalk-seeder-nothing.png" alt="Nothing Message Beanstalk Seeder" /></p>

<ul>
  <li><code class="highlighter-rouge">Worker</code></li>
</ul>

<p><img src="/assets/simple-routing-elastic-beanstalk-worker/worker-nothing.png" alt="Nothing Message Worker" /></p>

<p>I wrote a detailed guide in the <a href="https://github.com/gabrielweyer/simple-routing">GitHub repository</a>. Give it a try and let me know if it works for you.</p>


                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2018/01/28/simple-routing-elastic-beanstalk-worker/</guid>
                <description>
                    
                </description>
                <pubDate>Sun, 28 Jan 2018 20:24:33 +0000</pubDate>
                <author></author>
            </item>
        
    
        
            <item>
                <title>Links Insights #1</title>
                <link>https://gabrielweyer.github.io//2018/01/27/links-insights-1/</link>
                <content:encoded>
                    <![CDATA[
                    <p>Every now and then I stumble upon a brilliant post on Internet, I share some of those links on my <a href="https://www.diigo.com/user/gabrielweyer">Diigo profile</a> but the format is very succinct. I decided to start a new experiment and instead write full blog posts about those links. The first reason is quite selfish as I would like to keep a record of what I thought was interesting and why, I also hope to empower the reader so that she can decide if she wants to read the full post as some of them are lengthy.</p>

<p>I’m considering limiting each of those post to up to three links as to not require too much time from the reader.</p>

<p>This is inspired by the excellent work that Chris Alcock and Michael Wolfenden are doing with respectively <a href="http://blog.cwa.me.uk/">The Morning Brew</a> and <a href="https://michael-wolfenden.github.io/">The Wolf Report</a>. Don’t be surprised if I end up <del>stealing</del> borrowing some links from them.</p>

<p>Without further ado let me get started with the first links.<!--more--></p>

<h2 id="how-to-be-a-programmer-a-short-comprehensive-and-personal-summary">How To Be a Programmer: A Short, Comprehensive, and Personal Summary</h2>

<p><strong>Link</strong>: <a href="https://www.doc.ic.ac.uk/~susan/475/HowToBeAProgrammer.pdf">https://www.doc.ic.ac.uk/~susan/475/HowToBeAProgrammer.pdf</a></p>

<p>This is a 40 pages long PDF but contains some invaluable lessons especially if you’ve been in the field for only a few years.</p>

<blockquote>
  <p>A classic mistake is to use a hash table as a cache and forget to remove the references in the hash table. Since the reference remains, the referent is uncollectable but useless. This is called a memory leak.</p>
</blockquote>

<p>This is a mistake I’ve seen across almost all companies I’ve consulted for. I never managed to understand why dev teams adopted this anti-pattern as it has only drawbacks and is not simpler to write than a barebone caching system.</p>

<p>In the .NET word it’s often implemented via a <code class="highlighter-rouge">static private Dictionary</code>. Developers tend to use objects as key without understanding the requirements around equality but the main issue is that there is rarely code to remove keys which then requires an app pool restart (in a web app) in order to get rid of the stale key! This is compounded by the fact that sessions are often stored in process too and will be wiped out by an app pool restart.</p>

<ul>
  <li>Caching is hard, only introduce caching if you need to (based on performance measurements and performance targets)</li>
  <li>Use the <a href="https://docs.microsoft.com/en-us/dotnet/framework/performance/caching-in-net-framework-applications"><code class="highlighter-rouge">System.Runtime.Caching</code></a> namespace for in process caching</li>
  <li>Cache data for the smallest amount of time you can get away with</li>
  <li>Have an API allowing you to interact with your caching system</li>
  <li>Consider using a distributed caching system (<a href="https://redis.io/"><code class="highlighter-rouge">Redis</code></a> is great for this workload)</li>
  <li>When using a distributed caching system, consider using a short lived in process cache</li>
</ul>

<blockquote>
  <p>Never, ever, rest any hopes on vapor. Vapor is any alleged software that has been promised but is not yet available.</p>
</blockquote>

<p>This situation happened in one of my previous engagement. The feature we were developing was tightly integrated with a product being built by a startup. Their CEO flew down to our office, we listed the API endpoints we required and development started straight away. We even had a support engineer assigned to us!</p>

<p>Two things started to happen:</p>

<ul>
  <li>Already working features would break suddenly. After getting some support it would turn out that they pushed a new release that broke the feature. They would then deploy a patch which would break another feature!</li>
  <li>The core feature of this system was to poll third party services for created or modified entities. During our testing we noticed that entities were being missed frequently and we had to trigger the system manually for anything to happen. We raised those concerns and the startup promised to improve the reliability.</li>
</ul>

<p>We were developing at a faster pace and started to mock more and more dependencies. The release date was approaching and we had no confidence the integration would work. The product we were working on had long release cycles and was deployed by our customers on their own infrastructure, a failure would have been catastrophic. It was finally decided to test the reliability of our provider, we also included one of their competitor. After a few days of collecting data the verdict came in and things weren’t looking good, even though the competitor captured 100% of the entities we created our provider missed almost 30% of them!</p>

<p>The CTO decided to scrap the integration on the spot and we ended up throwing away half of the code base.</p>

<p>What we did right was to investigate the unknowns early on in the project. Instead of building our infrastructure we developed a small proof of concept and were able to get a contrived end-to-end execution. The lesson that I learned is that you should define a SLA for your provider from day one and measure it.</p>

<h2 id="how-to-write-a-git-commit-message">How to Write a Git Commit Message</h2>

<p><strong>Link</strong>: <a href="https://chris.beams.io/posts/git-commit/">https://chris.beams.io/posts/git-commit/</a></p>

<p>This is an amazing post, I’ve started to apply those rules a few months ago and my commit messages are so much better now.</p>

<blockquote>
  <p>Use the body to explain what and why vs. how</p>
</blockquote>

<p><a href="https://chris.beams.io/posts/git-commit/#why-not-how">Giving context in the body</a> is critical as often when fixing a bug I can see how it has been introduced but I have no idea why the change was made - even after reading the story associated with it! Please spend a few minutes explaining why and how a change was made, in 6 months or one year someone will be grateful. This someone might even be you!</p>

<blockquote>
  <p>Wrap the body at 72 characters</p>
</blockquote>

<p>I used to write my commit messages inline with the <code class="highlighter-rouge">-m</code> argument. After reading this <a href="https://chris.beams.io/posts/git-commit/#wrap-72">rule</a> I realized I needed an editor. I started to use <a href="https://notepad-plus-plus.org/">Notepad++</a> by configuring Git this way:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git config <span class="nt">--global</span> core.editor <span class="s2">"'C:</span><span class="se">\P</span><span class="s2">rogram Files (x86)</span><span class="se">\N</span><span class="s2">otepad++</span><span class="se">\n</span><span class="s2">otepad++.exe' -multiInst -notabbar -nosession -noPlugin"</span></code></pre></figure>

<p>Notepad++ accepts <a href="https://docs.notepad-plus-plus.org/index.php/Command_Line_Switches">command line switches</a> but there is no switch to set the text width. Git has a setting enforcing the text width but it does not work with Notepad++. The good news is that Git can also use notepad and the text width will be enforced:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git config <span class="nt">--global</span> core.editor notepad
git config <span class="nt">--global</span> format.commitMessageColumns 72</code></pre></figure>

<p>But the text will be wrapped <strong>after</strong> you save your commit message leading to a less than desirable result:</p>

<p><a href="/assets/links-insights-1/wrap-notepad.gif"><img src="/assets/links-insights-1/wrap-notepad.gif" alt="wrap-notepad" /></a></p>

<p>A better solution is to use vim instead:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git config <span class="nt">--global</span> core.editor vim
git config <span class="nt">--global</span> <span class="nt">--unset</span> format.commitMessageColumns</code></pre></figure>

<p><a href="/assets/links-insights-1/wrap-vim.gif"><img src="/assets/links-insights-1/wrap-vim.gif" alt="wrap-vim" /></a></p>

<p>I did not hit Enter while typing the body of this commit message, instead vim wrapped it for me automatically. If you want to learn more about configuring Git on Windows I wrote a <a href="https://github.com/gabrielweyer/nuggets/blob/master/git/git.md">tutorial</a> to get you started.</p>


                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2018/01/27/links-insights-1/</guid>
                <description>
                    
                </description>
                <pubDate>Sat, 27 Jan 2018 02:10:07 +0000</pubDate>
                <author></author>
            </item>
        
    
        
            <item>
                <title>Capture network packets with netsh</title>
                <link>https://gabrielweyer.github.io//2016/07/16/capture-network-packets-with-netsh/</link>
                <content:encoded>
                    <![CDATA[
                    <p>Another day, another “interesting” issue at a customer. After deploying our product we were left with a partially working web application. The product has been developed over many years and is a mix of ASP Classic, Web Forms, MVC and Web API. In this case ASP Classic pages were broken and would throw an error.</p>

<h2 id="ensuring-asp-classic-is-configured-properly">Ensuring ASP Classic is configured properly</h2>

<p>The first step is to ensure that IIS has been configured to execute ASP Classic and this is done easily by adding a dummy ASP page to the web application. After deploying this page I was able to confirm that it was working as expected.</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/5eb3198119bead02649c0fe11d733055.js"> </script>

<p><img src="/assets/2016-07-16-capture-network-packets-with-netsh/dummy-asp.png" alt="dummy-asp" /><!--more--></p>

<h2 id="enabling-failed-request-tracing">Enabling failed request tracing</h2>

<p>The features written in ASP Classic have been written many years ago and the developers didn’t consider logging as a key part of the development process. The end result being that when something goes wrong no logs get written by the application or to the event viewer.</p>

<p>The second step is to turn on the “<strong>Failed Request Tracing Rules</strong>“ and reload the failing page. Internet has a lot of tutorials around this but they’re all missing key steps, I’ll focus on those as you can find everything else easily.</p>

<p>“Failed Request Tracing Rules” will not be available in the IIS Manager if you didn’t turn on the <strong>Tracing</strong> feature in Windows Features:</p>

<p><img src="/assets/2016-07-16-capture-network-packets-with-netsh/tracing.png" alt="tracing" /></p>

<p>Another thing is that multiple sites could be writing traces at the same time. Each site will be writing to a different sub folder suffixed with the site ID:</p>

<p><img src="/assets/2016-07-16-capture-network-packets-with-netsh/site-id.gif" alt="site-id" /></p>

<p>Finally you can copy the log files back to your machine, don’t forget to copy the freb.xsl file too, you’ll then be able to open the XML files in Internet Explorer and look at a human readable representation of the log.</p>

<p><img src="/assets/2016-07-16-capture-network-packets-with-netsh/invalid-authority.png" alt="invalid-authority" /></p>

<p>All ASP Classic pages are calling an API endpoint in order to get a token (long story short: don’t ask - the user is signing-in in an AngularJS app backed by Web API and is then able to use seamlessly the pages hosted on MVC, Web Forms and Classic ASP). What is strange in this situation is that Internet Explorer is marking the TLS certificate as valid, so does Chrome. Even worse: the same ASP Classic page hosted on my machine calling the token endpoint on the remote server is successful! The Windows Certificate Manager is displaying the same message for the root CA, intermediate CA and certificate: ”This certificate is OK.”.</p>

<p>I then suspected the certificate might be using unsupported ciphers but it turned out that it wasn’t the case. I quickly wrote a C# Console application calling the same token endpoint - the HttpClient class is throwing meaningful errors - but to my dismay the C# code was able to call the endpoint successfully!</p>

<p>Armed with the ErrorCode “80072f0d” and the Description “The certificate authority is invalid or incorrect” I scoured Internet for some potential solutions. Everything I could find was related to invalid and self-signed certificates.</p>

<h2 id="capturing-packets-on-a-windows-server">Capturing packets on a Windows Server</h2>

<p>When people think “packet capture” they always assume they need to install <a href="https://www.wireshark.org/">Wireshark</a> (or another similar tool) whereas Windows Server is shipping with the ability to capture network packets with <a href="https://technet.microsoft.com/en-us/library/dd878517(v=ws.10).aspx">netsh</a> since Windows Server 2008 R2. The advantage of this solution is that you don’t need to install anything on the machine. To see if it’s available, all you need to do is open a command prompt and type:</p>

<figure class="highlight"><pre><code class="language-posh" data-lang="posh">netsh trace</code></pre></figure>

<p><img src="/assets/2016-07-16-capture-network-packets-with-netsh/netsh-trace.gif" alt="netsh-trace" /></p>

<p>Now that we know that <strong>trace</strong> is available we need to start capturing the packets and reproduce the problem. Launch an <strong>elevated</strong> command prompt and type:</p>

<figure class="highlight"><pre><code class="language-posh" data-lang="posh">netsh trace <span class="nb">start </span><span class="nv">tracefile</span><span class="o">=</span><span class="s2">"C:\tmp\traces\classic.etl"</span> <span class="nv">scenario</span><span class="o">=</span>internetclient <span class="nv">capture</span><span class="o">=</span>yes <span class="nv">maxsize</span><span class="o">=</span>200 <span class="nv">filemode</span><span class="o">=</span>circular <span class="nv">overwrite</span><span class="o">=</span>yes</code></pre></figure>

<p><strong>Note</strong>: the path needs to exist beforehand.</p>

<p><img src="/assets/2016-07-16-capture-network-packets-with-netsh/start-stop.gif" alt="start-stop" /></p>

<p>Starting and stopping the trace is actually slower that what is demonstrated above but I didn’t want lo lose your attention! And of course you would need to reproduce the issue before issuing:</p>

<figure class="highlight"><pre><code class="language-posh" data-lang="posh">netsh stop</code></pre></figure>

<h2 id="microsoft-message-analyzer">Microsoft Message Analyzer</h2>

<p>We now need to analyze this trace and this is done with the <a href="https://technet.microsoft.com/en-us/library/jj649776.aspx">Microsoft Message</a> <a href="https://blogs.technet.microsoft.com/messageanalyzer/">Analyzer</a> (can be downloaded <a href="https://www.microsoft.com/en-au/download/details.aspx?id=44226">here</a>). The Analyzer takes a long time to open the smallest trace but once the trace is loaded you can search quickly.</p>

<p>We’ll first look for an HTTP CONNECT, use this filter:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(HTTP.Method == "CONNECT") And
(HTTP.Uri.Host == "domain.name") And
(HTTP.Uri.Port == "port")
</code></pre></div></div>

<p><img src="/assets/2016-07-16-capture-network-packets-with-netsh/connect.png" alt="connect.png" /></p>

<p>As we can see the CONNECT was successful. Let’s investigate the TLS handshake now, this is handled by the TLS module so all we need to do is filter on this module only:</p>

<blockquote>
  <p>TLS</p>
</blockquote>

<p>This is what was captured when the C# application connected to the token endpoint:</p>

<p><img src="/assets/2016-07-16-capture-network-packets-with-netsh/c-sharp-tls.png" alt="c-sharp-tls" /></p>

<p>This is matching closely what is described in the <a href="https://tools.ietf.org/html/rfc5246#page-36">RFC 5246</a> (TLS 1.2).</p>

<p><img src="/assets/2016-07-16-capture-network-packets-with-netsh/full-handshake.png" alt="full-handshake" /></p>

<p>Let’s now capture the traffic when the VB code is trying to call the token endpoint.</p>

<p><img src="/assets/2016-07-16-capture-network-packets-with-netsh/vb-tls.png" alt="vb-tls.png" /></p>

<p>Great Scott! The server is sending <code class="highlighter-rouge">ServerHello</code> as expected but the client doesn’t reply with <code class="highlighter-rouge">ClientKeyExchange</code>. I then removed the filter and started to look at the messages below. My reasoning was that I should be finding some kind of error message soon after and here it was:</p>

<p><img src="/assets/2016-07-16-capture-network-packets-with-netsh/browsing-messages.png" alt="browsing-messages" /></p>

<p>The error message was:</p>

<blockquote>
  <p>A certificate chain processed, but terminated in a root certificate which is not trusted by the trust provider. (0x800B0109)</p>
</blockquote>

<p>As it turned out someone had messed up with the certificate store and removed the intermediate CA from the “Intermediate Certification Authorities”. As the root CA was still present in the “Trusted Root Certification Authorities” it was good enough for Internet Explorer and C# but it wasn’t for VB! I added the intermediate CA to the store and things started to work again.</p>


                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2016/07/16/capture-network-packets-with-netsh/</guid>
                <description>
                    
                </description>
                <pubDate>Sat, 16 Jul 2016 09:20:07 +0000</pubDate>
                <author></author>
            </item>
        
    
        
            <item>
                <title>beIN SPORTS CONNECT</title>
                <link>https://gabrielweyer.github.io//2016/06/13/bein-sports-connect/</link>
                <content:encoded>
                    <![CDATA[
                    <p>I like football, even with the time difference I try to watch at least the World Cup and the European Championship. I watched the last World Cup on <a href="http://www.sbs.com.au/">SBS</a> but this time around they only managed to secure a handful of games. As they’re a public service it makes sense after all that they wouldn’t buy the rights for all the games. A quick search on Google indicated that <a href="http://www.beinsportsconnect.com.au/home">beIN SPORTS CONNECT</a> is the way to go in Australia - I will refer to this service as beIN for the rest of this post.</p>

<h1 id="subscribing">Subscribing</h1>

<p>As the pricing seems reasonable I decided to go ahead. The page is loaded over HTTPS so we start well but to my surprise the form contains a <strong>password remainder</strong> field. Password remainders are a bad practice as users tend to fill them with their password (when allowed) or with a hint that is an obvious give away.<!--more--></p>

<p>As I don’t know any of my password, a password reminder is useless to me so I always generate a strong unique random password for this field. After trying to submit the form I got the following error:</p>

<p><img src="/assets/2016-06-13-bein-sports-connect/password-remainder.png" alt="password-remainder" /></p>

<p>I don’t understand the benefits of restricting the characters I can use. On the contrary it seems to indicate this site is potentially vulnerable to <a href="https://www.troyhunt.com/understanding-xss-input-sanitisation/">XSS</a>. I generate another reminder without “special” characters and get presented with another error:</p>

<p><img src="/assets/2016-06-13-bein-sports-connect/invalid-format.png" alt="invalid-format" /></p>

<p>So my valid email address is in an “Incorrect format”. How convenient should they ever decide to sell my data to a third party without me being able to track it back to them.</p>

<p>I start to have a bad feeling about the password requirements. After all the only one that is stated is that my password should be at least 6 characters. I decide to use “123456” and also use it as the password reminder. <strong>&lt;clickbait&gt;</strong>You won’t believe what happens next!<strong>&lt;/clickbait&gt;</strong>. Actually I’m sure you knew what would happen: the form happily accepted my password and let me reuse it in the reminder field. Well at least I “<em>can access the site</em> <strong>securely</strong>” (emphasis is mine).</p>

<p><img src="/assets/2016-06-13-bein-sports-connect/123456.png" alt="123456" /></p>

<p>One last thing before we move on to the dessert. Does it seem normal to be loading so many third party JavaScript files on a registration page? They’re even loading ads and we know what malicious ads do to your browser and it’s not kind (malware installation, credentials theft…).</p>

<p><img src="/assets/2016-06-13-bein-sports-connect/do-you-need-ads-on-signup.png" alt="do-you-need-ads-on-signup.png" /></p>

<h1 id="sign-inform-loaded-over-http">Sign-in form loaded over HTTP</h1>

<p>Yes you read that right. Even though the form is POSTing to HTTPS by then it is <a href="https://www.troyhunt.com/your-login-form-posts-to-https-but-you/">too late</a>. An attacker could have already intercepted the initial HTTP response and pointed the form to the URL of his choosing.</p>

<p>Sometimes websites still offer sign-in over HTTPS when you look for it but it doesn’t seem to be the case here.  <a href="https://secure.beinsportsconnect.com.au/">https://secure.beinsportsconnect.com.au/</a> redirects to <a href="http://www.beinsportsconnect.com.au/">http://www.beinsportsconnect.com.au/</a> and trying to access <a href="https://www.beinsportsconnect.com.au/">https://www.beinsportsconnect.com.au/</a> results in something you should never see:</p>

<p><img src="/assets/2016-06-13-bein-sports-connect/bein-loaded-over-https.png" alt="bein-loaded-over-https.png" /></p>

<h1 id="conclusion">Conclusion</h1>

<p>If you’re already using beIN or are planning on starting to use it at least generate a unique password so that when they get compromised attackers will not gain access to your account on other services.</p>

<p>I understand going all HTTPS would require a tremendous amount of work but beIN could first take some other steps that would make a big difference:</p>

<ul>
  <li>Remove the password reminder altogether</li>
  <li>Provide a dedicated HTTPS only sign-in page</li>
  <li>Stop loading third-party ads on the sign-in page</li>
</ul>


                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2016/06/13/bein-sports-connect/</guid>
                <description>
                    
                </description>
                <pubDate>Mon, 13 Jun 2016 10:46:32 +0000</pubDate>
                <author></author>
            </item>
        
    
        
            <item>
                <title>CodeCleanser</title>
                <link>https://gabrielweyer.github.io//2016/06/04/codecleanser/</link>
                <content:encoded>
                    <![CDATA[
                    <p>Recently I came up with an interesting issue at a customer. A governmental agency contacted us and informed us that due to a Windows update we could experience intermittent issue when trying to communicate with them. All I knew at this stage was that the issue would manifest itself when trying to upload a document and that the integration is done via DLLs that are wrapping a few web services.</p>

<p>After <a href="https://www.jetbrains.com/help/decompiler/2016.1/Generating_PDB_Files.html">generating PDBs</a> via <a href="https://www.jetbrains.com/decompiler/">dotPeek</a> and adding them to the Visual Studio symbol cache directory I was able to debug through those third party DLLs and confirm that the issue was indeed located in one of them.</p>

<p>Knowing the DLL is redistributed with the product, is in multiple production versions and that the source control’s history is pretty patchy, the question then become: <strong>if we were to get a new DLL could we use it for all the versions?</strong></p>

<p>To answer this question we will have to assess the differences between the DLL in each version.<!--more--></p>

<h1 id="first-naive-attempt-checksum">First naive attempt: checksum</h1>

<p>Windows ships with a few ways to compute a checksum, <a href="http://superuser.com/a/898377/128002">CertUtil</a> is one of them, PowerShell has a <a href="https://technet.microsoft.com/en-us/library/dn520872.aspx">Get-FileHash</a> cmdlet and this is what I’ll use:</p>

<figure class="highlight"><pre><code class="language-posh" data-lang="posh"><span class="nb">Get-FileHash</span> &lt;filepath&gt; -Algorithm MD5</code></pre></figure>

<p>For our purpose MD5 is good enough, if you want to ensure that a file hasn’t been tampered with you should be using SHA256 at least.</p>

<p>Sadly the three checksums for the three versions were different. But it doesn’t mean the DLLs are semantically different. It could have been metadata, different .NET Framework versions…</p>

<p>At this stage I could have used <a href="https://msdn.microsoft.com/en-us/library/f7dy01k1(v=vs.110).aspx">Ildasm</a> to try to diff the full source code in one file but according to my previous tries the output end up being different. For sake of completeness I tried again before writing this blog post.</p>

<figure class="highlight"><pre><code class="language-posh" data-lang="posh">ildasm &lt;dll-filepath&gt; /text /out<span class="o">=</span>&lt;output-filepath&gt;</code></pre></figure>

<p>This time is no exception, WinMerge indicates 348 differences! Some of them can be explained away:</p>

<p><a href="/assets/2016-06-04-codecleanser/different-dot-net-version.png"><img src="/assets/2016-06-04-codecleanser/different-dot-net-version.png" alt="different-dot-net-version" /></a></p>

<p>The assemblies have been compiled using different version of the .NET Framework, which makes sense as many years separate those two versions.</p>

<p>Next comes an interesting piece of information that explains why two builds of the same source code always result in two different DLLs:</p>

<p><a href="/assets/2016-06-04-codecleanser/mvid-image-base.png"><img src="/assets/2016-06-04-codecleanser/mvid-image-base.png" alt="mvid-image-base.png" /></a></p>

<p>The <a href="https://msdn.microsoft.com/en-us/library/system.reflection.module.moduleversionid(v=vs.110).aspx">MVID</a> changes at every single build, for our purpose we can safely ignore this difference, same goes for the Image base. The other differences are more worrying:</p>

<p><a href="/assets/2016-06-04-codecleanser/different-attributes.png"><img src="/assets/2016-06-04-codecleanser/different-attributes.png" alt="different-attributes.png" /></a></p>

<p>It looks like the Attributes are the same but in a different order. There are hundreds of such instances and as IL is harder to read than C# it’s time to move on to another strategy.</p>

<h1 id="plan-b-generate-a-project-via-dotpeek">Plan B: generate a project via dotPeek</h1>

<p>dotPeek can not only decompile IL to C#, it also can <a href="https://www.jetbrains.com/help/decompiler/2016.1/Exporting_Assembly_to_Project.html">generate a project from a DLL</a>. Let’s give it a spin and close this case!</p>

<p>According to WinMerge, every single file is different! Now I’m a sad panda :(, how could the C# differ even more than the IL? This is due to the fact that as a <em>convenience</em>, dotPeek kindly outputs the MVID and the assembly location at the top of each file:</p>

<p><a href="/assets/2016-06-04-codecleanser/dotpeek-mvid-assembly-location.png"><img src="/assets/2016-06-04-codecleanser/dotpeek-mvid-assembly-location.png" alt="dotpeek-mvid-assembly-location" /></a></p>

<p>In our use case, this is rather inconvenient. Luckily WinMerge has a feature called <a href="http://stackoverflow.com/a/22178182/57369">LineFilters</a> which allows to ignore lines based on Regular Expressions. Two filters later a lot of files are still different:</p>

<p><a href="/assets/2016-06-04-codecleanser/win-merge.png"><img src="/assets/2016-06-04-codecleanser/win-merge.png" alt="win-merge.png" /></a></p>

<p>It’s now confirmed, some attributes are in a different order! dotPeek has an <a href="https://youtrack.jetbrains.com/issue/DOTP-7063">opened bug</a> regarding this but it hasn’t been updated since October 2015 so we can assume it won’t be fixed anytime soon. By then I already spent 30 minutes on this task and being a consultant I can’t justify spending more time trying to find a (mostly) automated solution. I might be able to pull it off with a Regex but it might also turn to be a rabbit hole. According to the number of different files and hoping it would only be about attributes ordering it should take me less than an hour to go through the difference. It actually only took me 30 minutes and confirmed the assumption that only the order of the attributes was differing.</p>

<h1 id="enter-codecleanser">Enter CodeCleanser</h1>

<p>Fast forward two days, it’s Saturday morning and I’m wondering if I can use <a href="https://github.com/dotnet/roslyn">Roslyn</a> to solve this problem.</p>

<p>I had 3 objectives:</p>

<ol>
  <li>Get rid of the comments at the top of the file</li>
  <li>Sort Attributes by alphabetical order</li>
  <li>Wrap up before training</li>
</ol>

<p>The source code is available <a href="https://github.com/gabrielweyer/CodeCleanser">here</a>, feel free to use it and adapt it to your own needs.</p>

<h2 id="get-rid-of-the-comments-at-the-top-of-the-file">Get rid of the comments at the top of the file</h2>

<p>Let’s start by what seems the easiest: removing the comments at the top of the files. What’s very nice with Roslyn is that you don’t need an actual file, you can pass a string as an argument which makes unit testing very easy. As I’m only planning on doing cosmetic changes and I only care about comparing the two DLLs I don’t need to operate at a project or solution level.</p>

<p>Following the TDD principles I’ll first write a <a href="https://github.com/gabrielweyer/CodeCleanser/blob/4b7b769bdf104461decc7db0f6ce46a890de4351/Tests/RemoveLeadingTriviaTests.cs#L8-L55">test</a>:</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/b6aaa2c60ba20f8340d32edd4ff87265.js"> </script>

<p>This test ensures that everything before the first using statement is removed. Let’s now look at the <a href="https://github.com/gabrielweyer/CodeCleanser/blob/4b7b769bdf104461decc7db0f6ce46a890de4351/Logic/CodeCleaner.cs#L39-L47">implementation</a>:</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/ac0976203a5315f16e1bac81963a6a8b.js"> </script>

<p>The Roslyn documentation defines a <a href="https://github.com/dotnet/roslyn/wiki/Roslyn%20Overview#syntax-trivia">trivia</a> as:</p>

<blockquote>
  <p>Syntax trivia represent the parts of the source text that are largely insignificant for normal understanding of the code, such as whitespace, comments, and preprocessor directives.</p>
</blockquote>

<p>All the code is doing is replace each leading trivia with an empty trivia. I’m sure there is a better way of doing this but this works well enough for my purpose.</p>

<h2 id="sort-attributes-by-alphabetical-order">Sort Attributes by alphabetical order</h2>

<p>Again we’ll start with a <a href="https://github.com/gabrielweyer/CodeCleanser/blob/4b7b769bdf104461decc7db0f6ce46a890de4351/Tests/SortAttributesAlphabeticallyTests.cs#L8-L51">test</a>:</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/786db1ecb44c689ce18532cda794f0f7.js"> </script>

<p>We’ll need to pack a bit more power this time. In my case the issue only happened on class, enum and property declarations, CSharpSyntaxRewriter seems to be a good candidate for what I want to achieve. The implementation can be found <a href="https://github.com/gabrielweyer/CodeCleanser/blob/4b7b769bdf104461decc7db0f6ce46a890de4351/Logic/AttributesSorter.cs#L46-L66">here</a>:</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/2daec819f25eca2679174c08985b599e.js"> </script>

<p>I had to make sure the blank line preceding the first attribute didn’t get moved down and that’s why there is some logic around leading trivia (prompted by this <a href="https://github.com/gabrielweyer/CodeCleanser/blob/4b7b769bdf104461decc7db0f6ce46a890de4351/Tests/SortAttributesAlphabeticallyTests.cs#L180-L219">test</a>). Initially I was storing the AttributeListSyntax in a dictionary using the first attribute name as a key, of course I forgot that you could have the same attribute multiple time on a single declaration. It prompted me to write this <a href="https://github.com/gabrielweyer/CodeCleanser/blob/4b7b769bdf104461decc7db0f6ce46a890de4351/Tests/SortAttributesAlphabeticallyTests.cs#L53-L9">test</a>) and adapt my implementation. It took me a few tries to get it right and rather than having to replace the files after each attempt I created a local Git repository, committed the unmodified files and issued a git reset after each attempt.</p>

<p>After running CodeCleanser on the three DLLs I was able to confirm they were identical.</p>

<h1 id="plot-twist">Plot twist</h1>

<p>I contacted the governmental agency and asked them if they could provide us with the new version of their DLL. To my surprise they told me that they’re distributing source code only. Sure enough after a few Git commands I discovered we had the code under source control all along! Funnily enough nobody knew about it and it wouldn’t have helped anyway as history only go two years back.</p>

<h1 id="takeaways">Takeaways</h1>

<p>The main takeaway is that everything is immutable in Roslyn. I kept forgetting that Add and AddRange would return a new AttributeListSyntax instead of performing an in place Add. As those methods have not been marked as Pure, ReSharper would not warm me that I didn’t use the return type and I would end up with an empty AttributeListSyntax. After 10 seconds of debugging I would exclaim “I’m an idiot” every single time, never gets old! Roslyn has changed a lot between the different Release Candidates and many code sample from Internet won’t compile.</p>

<p>During my research I found <a href="https://roslynquoter.azurewebsites.net/">https://roslynquoter.azurewebsites.net/</a>, it takes C# as an input and writes out the Roslyn code that will generate it.</p>

<p>I realize CodeCleanser doesn’t do much and the whole comparing process still requires some manual steps but I hope it can help someone else.</p>


                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2016/06/04/codecleanser/</guid>
                <description>
                    
                </description>
                <pubDate>Sat, 04 Jun 2016 00:41:48 +0000</pubDate>
                <author></author>
            </item>
        
    
        
            <item>
                <title>Barnes and Noble: a tale of poor security practices</title>
                <link>https://gabrielweyer.github.io//2014/12/07/barnes-and-noble-a-tale-of-poor-security-practices/</link>
                <content:encoded>
                    <![CDATA[
                    <p>Being the happy owner of a Kindle I usually buy my ebooks on Amazon. They have a very large selection to choose from and normally sell all the latest releases. To my surprise they only had “<a href="(http://us.macmillan.com/enigmaofchina/qiuxiaolong)">Enigma of China</a>” from Qiu Xialong in paperback and hardcover formats. <a href="http://store.kobobooks.com/en-US/Search/Query?query=Enigma%20of%20China&amp;dontModifyQuery=True">Kobo</a> didn’t have it at all but after searching for a while I found out that Barnes &amp; Noble sold it as a <a href="http://www.barnesandnoble.com/w/enigma-of-china-qiu-xiaolong/1114701902?ean=9781250025814">NOOK Book</a> for $10.</p>

<p>So far, so good or so it seemed. It turned out that Barnes &amp; Noble has such a lax approach of security that at the end I decided not to purchase from them. You’ll find below the reasons that motivated my decision.<!--more--></p>

<h2 id="i-sign-in-and-registration-in-a-new-window">I Sign in and registration in a new window</h2>

<p>The first issue made itself apparent very quickly: when clicking on the “Sign in” link the browser will open a new window. This new window does not contain a toolbar, which means that users won’t be able to use some password managers (such as 1Password, the Chrome extension being accessible through a button in the toolbar).</p>

<p>I know that you can work around it as the <a href="https://www.barnesandnoble.com/signin">Sign in</a> page is also available directly on the website. You can also use the shortcut “Ctrl + " within the new window in order to enter your credentials via 1Password but I don’t think that everybody is a power user. Basically opening a new window instead of loading a page creates extra-friction when using a password manager.</p>

<p>Of course the registration page is also located in a new window and within this page things got even more interesting!</p>

<h2 id="ii-mixed-content-warning">II Mixed content warning</h2>

<p>As they’re loading a dedicated sign in page, you would expect Barnes &amp; Noble to use SSL properly. As it turned out the source code contains a link to an HTTP iframe. Chrome (rightly so) blocks the content and displays a warning:</p>

<p><a href="/assets/2014-12-07-barnes-and-noble-a-tale-of-poor-security-practices/barnes-and-noble-sign-in-mixed-content-warning.png"><img src="/assets/2014-12-07-barnes-and-noble-a-tale-of-poor-security-practices/barnes-and-noble-sign-in-mixed-content-warning.png" alt="Sign in: mixed content warning" /></a></p>

<p>The most interesting part is that the tracking page is also available via <a href="https://4476037.fls.doubleclick.net/activityi;cat=signi0;ord=1641192771;src=4476037;type=signi0?">SSL</a>. The sign in page being loaded only over SSL, the link could have been hardcoded as SSL too.</p>

<h2 id="iii-weak-password-policy">III Weak password policy</h2>

<p>So Barnes and Noble decided to limit the number of characters I can use in my password to 15. Not only this but they’re also preventing me from using any special characters. I’m not sure what “<em>numeric symbol</em>” means, some special characters might be allowed but as a user I’ve no idea which one I can use.</p>

<p><a href="/assets/2014-12-07-barnes-and-noble-a-tale-of-poor-security-practices/barnes-and-noble-password-policy.png"><img src="/assets/2014-12-07-barnes-and-noble-a-tale-of-poor-security-practices/barnes-and-noble-password-policy.png" alt="Barnes &amp; noble: password policy" /></a></p>

<p>It’s quite strange that the security answer is limited to 15 characters, what if my favorite movie is “<a href="http://www.imdb.com/title/tt0111161/">The Shawshank Redemption</a>)”? Security questions are a terrible practice anyway as people tend to use easily guessable answers (as you can see in the screenshot I get my password manager to generate one for me).</p>

<h2 id="iv-mixed-content-warning-on-payment-page">IV Mixed content warning on payment page</h2>

<p>Even the payment page comes with a shiny warning:</p>

<p><a href="/assets/2014-12-07-barnes-and-noble-a-tale-of-poor-security-practices/barnes-and-noble-payment-mixed-content-warning.png"><img src="/assets/2014-12-07-barnes-and-noble-a-tale-of-poor-security-practices/barnes-and-noble-payment-mixed-content-warning.png" alt="Barnes &amp; Noble: payment mixed content warning" /></a></p>

<p>This is due to the fact that the search form is posting to an <a href="http://www.barnesandnoble.com/s/Enigma-of-China?store=allproducts&amp;keyword=Enigma+of+China">HTTP endpoint</a> even when the page is loaded over SSL.</p>

<p>At this stage I decided to give up, buying this book is not worth taking the risk of exposing my credit card data.</p>

<h2 id="special-bonus-credit-card-number-used-in-the-drm">Special bonus: credit card number used in the DRM</h2>

<p>Barnes and Noble decided to protect its content via the highly controversial use of a <a href="http://en.wikipedia.org/wiki/Digital_rights_management">DRM</a> system (Amazon has made the same choice). The goal is to prevent the consumer from sharing it’s purchase with any other user. Of course DRM don’t work and they’re only being a major annoyance to the people actually paying for content.</p>

<p>What is unusual is that Barnes and Noble decided that it would use your <strong>credit card number</strong> in order to sign the DRM. This means that this data is included with your ebooks and could potentially be extracted.</p>

<h2 id="how-could-barnes--noble-address-those-issues">How could Barnes &amp; Noble address those issues?</h2>

<p>Instead of opening a new window for sign in and registration the site should merely link to a new page. As a matter of fact they already have them in place: <a href="https://www.barnesandnoble.com/signin">sign in</a> and <a href="https://www.barnesandnoble.com/register">registration</a>.</p>

<p>They should also link to the SSL URL of the DoubleClick script on their sign in and registration page.</p>

<p>Passwords should not be restricted in terms of character set or length. If you really want to have an upper limit it should be set to something ridiculously high (such as 100 characters). In fact they should instead enforce stronger passwords (combination of letters, numbers and symbols).</p>

<p>The payment should be on a page of its own and not use the same layout (I don’t think that users need to be able to look for a book while entering their credit card details).</p>

<p>And please stop encoding my credit card number into the books I’m buying from you. If you’re afraid I’ll remove your precious DRM and share the book on Internet there is nothing preventing you to use a unique string linked to my account.</p>

<p>Some of those points are extremely easy to address (new page for sign in and registration, SSL URL for the tracking script), others will certainly be more challenging but are nevertheless necessary.</p>


                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2014/12/07/barnes-and-noble-a-tale-of-poor-security-practices/</guid>
                <description>
                    
                </description>
                <pubDate>Sun, 07 Dec 2014 06:16:14 +0000</pubDate>
                <author></author>
            </item>
        
    
        
            <item>
                <title>The Good, the Bad and the Ugly of password practices</title>
                <link>https://gabrielweyer.github.io//2014/04/27/the-good-the-bad-and-the-ugly-of-password-practices/</link>
                <content:encoded>
                    <![CDATA[
                    <p>Internet has taken a preponderant place in our lives and most of us regularly purchase goods on Internet or use Internet banking. The access to the services we use is protected by a password and humans are not good at managing passwords:</p>

<ul>
  <li>Most of us will reuse the same password on many services (combine this with the fact that people also use the same email address to log in into said services and you get an explosive mix when security is breached on one <a href="http://www.geekosystem.com/gawker-hack-acai-spam-twitter/">service</a>).</li>
  <li>Most of us will use weak passwords, basically as weak as the service will allow. Not only our passwords are weak they’re also extremely <a href="https://www.duosecurity.com/blog/brief-analysis-of-the-gawker-password-dump">predictable</a>.</li>
</ul>

<p>To address those issues you need to use <strong>strong unique</strong> passwords. By <strong>strong</strong> I mean that your passwords should be:</p>

<ul>
  <li>long (let’s say at least 25 characters)</li>
  <li>a mix of lower / upper case letters, digits and symbols</li>
  <li>randomly generated (by a random generator not by you typing random keys on your keyboard)</li>
</ul>

<p>By <strong>unique</strong> I mean that you should <em>never</em> reuse a password. You should set a different password on each service. As we tend to use many services and tend to log in from multiple devices (home and work computers, smartphones, tablets..) it makes it impossible to remember all those strong passwords.</p>

<p>Google has <a href="https://www.youtube.com/watch?v=0RCsHJfHL_4">recommended</a> the use of sentence and substitution, something even stronger has been advocated by <a href="http://xkcd.com/936/">xkcd</a>. But this doesn’t work. I use over a hundred different services, how could I remember a hundred different sentences? Common substitutions (the one you will use) are also well documented and will be attempted by the attackers to guess your password. Other experts have advised to <a href="https://medium.com/cyber-security/9ed56d483eb">get rid of passwords</a> altogether, but this opinion is unconventional to say the least.</p>

<p>Want it or not we’re stuck with passwords for the  predictable future. Luckily there is a solution: it’s called a password manager. With a password manager you’ll only need to remember one password (the master password), all the other ones will be entered automatically for you in the login forms. I use <a href="https://agilebits.com/onepassword">1Password</a>, but there are other products on the market: <a href="https://lastpass.com/">LastPass</a>, <a href="http://keepass.info/">KeePass</a>, <a href="http://www.roboform.com/">RoboForm</a>… Most of those products are not free but I’m sure you’ll prefer to drop a few dozens dollars every few years instead of seeing your online (and sometimes offline) life ruined.</p>

<p>Now that I’ve addressed password best practices on the users’ side it’s time to mention the other side. The services that you use should do everything they can in order to protect your password. There is a <a href="http://www.troyhunt.com/2011/06/owasp-top-10-for-net-developers-part-7.html">lot</a> to say in this area but I decided to address the features that are easily observable:</p>

<ul>
  <li>passwords requirements: services shouldn’t restrict the length of our passwords (at least not smaller than a few dozens characters) or the characters’ set that we can use (this would reduce the entropy)</li>
  <li><a href="http://www.troyhunt.com/2013/05/your-login-form-posts-to-https-but-you.html">proper use of HTTPS</a></li>
  <li><a href="http://www.troyhunt.com/2012/05/everything-you-ever-wanted-to-know.html">reset password feature</a></li>
</ul>

<p>Due to the <a href="http://heartbleed.com/">Heartbleed</a> vulnerability I decided to change some of my passwords recently. To my surprise many well known services impose some strong restrictions on the passwords users can set. Shall we get started? The offenders are ordered from worst ones to the most benign ones.<!--more--></p>

<h2 id="the-ugly">The ugly</h2>

<blockquote>
  <p>Use at your own risk. Most of those services do not use HTTPS properly or force you to choose passwords that are easily guessable.</p>
</blockquote>

<ul>
  <li><a href="http://www.airfrance.fr/cgi-bin/AF/FR/en/common/home/home/HomePageAction.do">Air France</a></li>
</ul>

<p>Not only Air France is loading the login form over HTTP, the password policy they enforce is a 4 digits PIN!</p>

<ul>
  <li><a href="https://www.caisse-epargne.fr/particuliers/ile-de-france/accueil.aspx">Caisse d’Epargne</a></li>
</ul>

<p>One of the biggest French bank, forcing its users to use a 5 digits PIN as a password (and the login is the account number which is a semi-public information).</p>

<ul>
  <li><a href="http://weibo.com/">Weibo</a></li>
</ul>

<p>The service logs users in over HTTP and limiting the password length to 16 characters.</p>

<ul>
  <li><a href="http://doodle.com/en/">Doodle</a></li>
</ul>

<p>The service logs users in over HTTP! According to <a href="http://en.blog.doodle.com/2014/04/10/important-security-news-from-doodle/">them</a>, they updated their system to patch the vulnerability. Of course as they don’t use HTTPS they were never vulnerable to this specific vulnerability in the first place.</p>

<h2 id="the-bad">The bad</h2>

<blockquote>
  <p>Use with caution. Those services are not getting security, they’re exposing your passwords in clear via email.</p>
</blockquote>

<ul>
  <li><a href="https://uberstrike.com/">UberStrike</a></li>
</ul>

<p>The service is currently using an expired certificate. When changing your password you’ll receive an email containing your new password in clear (and stating “We’ve reset your UberStrike password” [<em>sic</em>]).</p>

<p><a href="/assets/2014-04-27-the-good-the-bad-and-the-ugly-of-password-practices/uberstrike-change-password.png"><img src="/assets/2014-04-27-the-good-the-bad-and-the-ugly-of-password-practices/uberstrike-change-password.png" alt="uberstrike-change-password" /></a></p>

<ul>
  <li><a href="https://ielts.britishcouncil.org/CandidateLogin.aspx">IELTS</a></li>
</ul>

<p>The service does not allow you to change your password. This password is in fact your reference number that you need to use in every communication with IELTS’ staff.</p>

<ul>
  <li><a href="https://www.astrill.com/">Astrill</a></li>
</ul>

<p>Astrill provide VPN services and allow (among other things) to access blocked websites from Mainland China. A VPN also prevents attackers from listening to your traffic. This service is mainly about security and so you would expect them to have pretty good practices in terms of passwords. It turns out that if you’re not currently a paying customer you can’t change your password. Even worse the support staff does not have the ability to delete your account and will instead send you a new password in clear via email (you can read the full conversation <a href="/assets/2014-04-27-the-good-the-bad-and-the-ugly-of-password-practices/astrill-change-password.png">here</a>)!</p>

<p><a href="/assets/2014-04-27-the-good-the-bad-and-the-ugly-of-password-practices/astrill-reset-password1.png"><img src="/assets/2014-04-27-the-good-the-bad-and-the-ugly-of-password-practices/astrill-reset-password1.png" alt="astrill-reset-password" /></a></p>

<ul>
  <li><a href="https://depot-marque.inpi.fr/index.html">INPI</a></li>
</ul>

<p>This is the French department in charge of registering patents and trademarks. When creating an account they’re kind enough to send you your password via email in clear. At least they’re deleting inactive accounts after three months.</p>

<p><a href="/assets/2014-04-27-the-good-the-bad-and-the-ugly-of-password-practices/inpi-create-account.png"><img src="/assets/2014-04-27-the-good-the-bad-and-the-ugly-of-password-practices/inpi-create-account.png" alt="inpi-create-account" /></a></p>

<h2 id="the-almost-good">The (almost) good</h2>

<blockquote>
  <p>In this category you’ll find the offenders that almost got it right. But their policies are not good enough to get them off the hook. It’s all related to the maximal length of passwords and the allowed symbols.</p>
</blockquote>

<ul>
  <li><a href="http://us.battle.net/en/">Battle.net</a></li>
</ul>

<blockquote>
  <p>Your password must be between 8–16 characters in length. Your password may only contain alphabetic characters (A–Z), numeric characters (0–9), and punctuation.</p>
</blockquote>

<p>Blizzard has been battling accounts hijacking for years. A better password policy would certainly help protect the accounts of their users.</p>

<ul>
  <li><a href="http://www.free.fr/adsl/index.html">Free</a></li>
</ul>

<blockquote>
  <p>Your password can’t be longer than 16 characters. Characters are restricted to a-z, A-Z, 0-9, #$,;.:*@[]()?+=-_%</p>
</blockquote>

<ul>
  <li><a href="https://www.mymyki.com.au/NTSWebPortal/Common/getmyki/GetMykiOption.aspx?menu=Get%20myki">Myki</a></li>
</ul>

<blockquote>
  <p>Your password can’t be longer than 15 characters.</p>
</blockquote>

<ul>
  <li><a href="http://www.optus.com.au/">Optus</a></li>
</ul>

<blockquote>
  <p>Your password can’t be longer than 15 characters.</p>
</blockquote>

<ul>
  <li><a href="https://www.commbank.com.au/">Commonwealth Bank</a></li>
</ul>

<blockquote>
  <p>8 and 16 characters long. can contain most characters except &lt;&gt;^`{}~=</p>
</blockquote>

<p>The 16 characters limit is completely unacceptable coming from a bank!</p>

<ul>
  <li><a href="http://www.microsoft.com/en-au/default.aspx">Microsoft</a></li>
</ul>

<blockquote>
  <p>Your password can’t be longer than 16 characters.</p>
</blockquote>

<p>This is the biggest company present in this list and it’s quite disappointing coming from an enterprise software company. Microsoft accounts are also used by businesses to access Azure, MSDN…</p>

<ul>
  <li><a href="http://www.originenergy.com.au/">Origin</a></li>
</ul>

<p>The energy company in Australia (not the gaming service operated by EA).</p>

<p>Not only you can’t use symbols but also the password length is limited to 20 characters. Origin only allows you to change your password once per 24 hours, I’ve no idea why this is the case on how it can make the service more secure.</p>

<ul>
  <li><a href="http://en.voyages-sncf.com/en/">SNCF</a></li>
</ul>

<blockquote>
  <p>Password must only contain numbers and/or letters. The length should not be bigger than 25 characters.</p>
</blockquote>

<ul>
  <li><a href="http://www.renren.com/">RenRen</a></li>
</ul>

<p>RenRen is limiting the password length to 20 characters.</p>

<ul>
  <li><a href="http://www.viadeo.com/">Viadeo</a></li>
</ul>

<blockquote>
  <p>Your password can’t be longer than 20 characters.</p>
</blockquote>

<ul>
  <li><a href="https://btguard.com/">BTGuard</a></li>
</ul>

<p>The service prevents you from using symbols altogether:</p>

<blockquote>
  <p>Password must only contain numbers and/or letters.</p>
</blockquote>

<ul>
  <li><a href="https://my.gov.au/">myGov</a></li>
</ul>

<p>This website allows Australians to manage their social benefits (medicare, Centrelink, child support…). The service has a pretty good policy but restricts you from using certain symbols:</p>

<blockquote>
  <p>You can strengthen your password by including a mixture of upper and lower case letters, numbers, and the following special characters: !, @, #, $, %, ^, &amp;, *.</p>
</blockquote>

<ul>
  <li><a href="http://wordpress.com/">WordPress</a></li>
</ul>

<blockquote>
  <p>ERROR: Passwords may not contain the character “\”.</p>
</blockquote>

<p>This is a minor violation as WordPress is only preventing us from using a single symbol and this is why the service sits at the last position of this list.</p>


                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2014/04/27/the-good-the-bad-and-the-ugly-of-password-practices/</guid>
                <description>
                    
                </description>
                <pubDate>Sun, 27 Apr 2014 09:17:31 +0000</pubDate>
                <author></author>
            </item>
        
    
        
            <item>
                <title>Why You Should Not Use Chrome Extensions</title>
                <link>https://gabrielweyer.github.io//2014/01/07/why-you-should-not-use-chrome-extensions/</link>
                <content:encoded>
                    <![CDATA[
                    <p>Google Chrome Extensions have been <a href="http://en.wikipedia.org/wiki/Google_Chrome#Extensions">launched</a> officially in January 2010. Their goal is to extend the browser by providing additional features, for example you could add a weather extension and then be able to see the weather’s forecast in your city in one click. Extensions have become widely popular and you’re now wondering what could be the issue with them.</p>

<h1 id="much-more-power-than-expected">Much more power than expected</h1>

<p>Google <a href="/assets/2014-01-07-why-you-should-not-use-chrome-extensions/ads-13.png">uses</a> a system of <a href="https://support.google.com/chrome_webstore/answer/186213?hl=en&amp;rd=1">permissions</a> to determine what an extension will be able to do once installed. Those permissions are divided into three alert levels: high, medium and low. So far, so good? Not really, even the low level allows an extension to harvest your browsing history and the content of your clipboard.</p>

<p>Extensions are built using JavaScript and HTML. Those are the exact same technologies used on websites. I’m sure you’re aware how modern websites refresh part of their content without reloading the whole page. Extensions can do this too: nothing is preventing a low level alert extension to detect that you’re pasting your email and password on Facebook in order to login. Then the extension can send the collected information to a remote server.</p>

<p>In this case the exploit is fairly limited, you need the user to be copying / pasting the email and password for this to work (the extension would also collect everything that the user is copying and pasting). Whats about the medium and high level alert? This is where the real fun start, at this level of trust extensions can do whatever they want!</p>

<p>A medium alert level extension can generate HTML elements on a page. It could perfectly hide a login form, replace it by it’s own, harvest your credentials and submit the hidden login form. A high alert level extension can do similar things but on your computer! This means that it could take your picture via your webcam, browse your hard drive looking for interesting files…</p>

<p>You would think that all of this is hypothetical and Google would certainly remove any malicious extension, but in this case you would be wrong.<!--more--></p>

<h1 id="technical-breakdown-of-a-malicious-extension">Technical breakdown of a malicious extension</h1>

<p><strong>Warning</strong>: this part is somehow technical.</p>

<p>On the 5th of December 2013 I noticed that ads started to appear on top of Google Image Search. I’ve never seen ads there before. It also had this strange sentence “Ads not from this site”. I was intrigued and it didn’t take me long to find the culprit: <a href="https://chrome.google.com/webstore/detail/awesome-screenshot-captur/alelhddbbhepgpmgidjdcjakblofbmce/details">Awesome Screenshot: Capture &amp; Annotate</a>.</p>

<p>Turns out a new version was published on the 5th of December and this is when it started to display ads. I wasn’t the only user to notice:</p>

<p><a href="/assets/2014-01-07-why-you-should-not-use-chrome-extensions/ads-13.png"><img src="/assets/2014-01-07-why-you-should-not-use-chrome-extensions/ads-13.png" alt="ads-1" /></a> <a href="/assets/2014-01-07-why-you-should-not-use-chrome-extensions/ads-23.png"><img src="/assets/2014-01-07-why-you-should-not-use-chrome-extensions/ads-23.png" alt="ads-2" /></a> <a href="/assets/2014-01-07-why-you-should-not-use-chrome-extensions/ads-32.png"><img src="/assets/2014-01-07-why-you-should-not-use-chrome-extensions/ads-32.png" alt="ads-3" /></a></p>

<p>After a couple of hours everything went back to normal: I enabled the extension again and noticed that it wasn’t displaying ads anymore. I decided to dig deeper and downloaded the source code of the extension.</p>

<p>Everything starts here: <code class="highlighter-rouge">\javascripts\content_script.js</code> [<a href="https://github.com/gabrielweyer/code-sample/blob/master/technical-blog/chrome-ext/src/3.5.7/javascripts/content_script.js#L763-L781">line:763-781</a>]</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/8248634.js"> </script>

<p>This code is commented. I suspect this is because they pushed a second version the same day (this file was the only one modified on the 5th of December). It’s very easy to understand what’s going on here: if the user is browsing a site owned by Google the code should call <code class="highlighter-rouge">addAD</code> (the function name in itself is rather explicit). The script will also reload the ads 1.5 seconds after the user has finished typing in the search bar.</p>

<p>The function <code class="highlighter-rouge">addAD</code> is located in the same file `\javascripts\content_script.js [<a href="https://github.com/gabrielweyer/code-sample/blob/master/technical-blog/chrome-ext/src/3.5.7/javascripts/content_script.js#L631-L668">line:631-668</a>]. The code is a bit too long to past here but it’s calling another function [<a href="https://github.com/gabrielweyer/code-sample/blob/master/technical-blog/chrome-ext/src/3.5.7/javascripts/content_script.js#L635">line:635</a>]</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/8248711.js"> </script>

<p>This function will retrieve the ads and create the markup [<a href="https://github.com/gabrielweyer/code-sample/blob/master/technical-blog/chrome-ext/src/3.5.7/javascripts/content_script.js#L644-L646">line:644-646</a>]</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/8248593.js"> </script>

<p>The best part is located here: <code class="highlighter-rouge">\javascripts\bg.js</code> [<a href="https://github.com/gabrielweyer/code-sample/blob/master/technical-blog/chrome-ext/src/3.5.7/javascripts/bg.js#L154-L184">line:154-184</a>]</p>

<p>First they’re doing a HTTP GET at: <a href="http://api.hostip.info/get_json.php">http://api.hostip.info/get_json.php</a> and getting JSON as a reply</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/8248818.js"> </script>

<p>The funny part is that I’m located in Melbourne and I was not using a proxy or a VPN at this time!</p>

<p>Then this line says it all [<a href="https://github.com/gabrielweyer/code-sample/blob/master/technical-blog/chrome-ext/src/3.5.7/javascripts/bg.js#L162">line:162</a>]</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/8248849.js"> </script>

<p>I find it really scary. These guys are obviously not very smart, they could just have replaced Google Ads by their own and keep exactly the same design. This way they could have stayed unnoticed for much longer. This also means (most likely) that there is nothing preventing extensions from harvesting passwords (either directly via JavaScript or by inserting DOM elements in the page). This extension has over a million users, the fact that they were not taken down indicates that Google needs to improve its security practices for extensions.</p>

<h1 id="why-hasnt-this-been-exploited-more">Why hasn’t this been exploited more?</h1>

<p>I suspect it has been used widely already. Recipe: create a popular extension (emulate a paying service for free, launch a football world cup tracker…), push an update that will sometimes be malicious. If the number of reports does not reach a certain threshold Google won’t investigate. Rinse and repeat.</p>

<p>In fact this same extension was used again but for a different attack on the 17th of December:</p>

<p><a href="/assets/2014-01-07-why-you-should-not-use-chrome-extensions/data-collection-1.png"><img src="/assets/2014-01-07-why-you-should-not-use-chrome-extensions/data-collection-1.png" alt="data-collection-1" /></a> <a href="/assets/2014-01-07-why-you-should-not-use-chrome-extensions/data-collection-2.png"><img src="/assets/2014-01-07-why-you-should-not-use-chrome-extensions/data-collection-2.png" alt="data-collection-2" /></a></p>

<p>There is no accountability: most of the companies publishing extensions are completely unknown. Even if Google was to act they could just create new extensions under another name.</p>

<h1 id="take-away">Take Away</h1>

<p>I stopped using Chrome extensions and I think you should too. The risks vastly overshadow the benefits. In fact I think it is safe to use Chrome Extensions in a couple of cases:</p>

<ul>
  <li>When they come from a reputable source (Google, Evernote, Dropbox…)</li>
  <li>When they’re part of a service you’re paying for (1Password for example)</li>
  <li>When they’re open source</li>
</ul>


                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2014/01/07/why-you-should-not-use-chrome-extensions/</guid>
                <description>
                    
                </description>
                <pubDate>Tue, 07 Jan 2014 09:13:53 +0000</pubDate>
                <author></author>
            </item>
        
    
  </channel>
</rss>
