I"Y'<p>I was recently faced with an interesting problem. A company wanted to cost the migration of thousands of <code class="language-plaintext highlighter-rouge">VMs</code> to <code class="language-plaintext highlighter-rouge">Azure</code> using a <a href="https://docs.microsoft.com/en-us/azure/architecture/cloud-adoption/digital-estate/5-rs-of-rationalization#rehost">lift and shift</a> approach (also known as rehost). Due to the short deadline, we were not able to get our hands on detailed data. All we were provided with was a machine name, <code class="language-plaintext highlighter-rouge">CPU</code> cores count, <code class="language-plaintext highlighter-rouge">RAM</code> and a description field that was sometimes populated. Utilisation, storage and network usage were notably missing. We knew we couldn’t cost the migration accurately due to these unknowns, but we had enough data to cost the <code class="language-plaintext highlighter-rouge">VMs</code> themselves as we had access to <code class="language-plaintext highlighter-rouge">CPU</code> cores count and <code class="language-plaintext highlighter-rouge">RAM</code>. I must also add that the <code class="language-plaintext highlighter-rouge">VMs</code> varied greatly in their hardware specifications.</p>

<p><code class="language-plaintext highlighter-rouge">Microsoft</code> offers a <a href="https://azure.microsoft.com/en-us/pricing/calculator/?service=virtual-machines">pricing calculator</a> but it only supports manual input which disqualified it for our use case. A few <code class="language-plaintext highlighter-rouge">Microsoft</code> employees wrote web applications automating the pricing of <code class="language-plaintext highlighter-rouge">VMs</code> by importing <code class="language-plaintext highlighter-rouge">Excel</code> spreadsheets or <code class="language-plaintext highlighter-rouge">CSV</code> files. The ones I tried only offered <code class="language-plaintext highlighter-rouge">USD</code> as a currency and choked for anything bigger than a few hundred <code class="language-plaintext highlighter-rouge">VMs</code>. The output file was using a <code class="language-plaintext highlighter-rouge">en-us</code> culture so it had to be post-processed before being open in <code class="language-plaintext highlighter-rouge">Excel</code>. I didn’t have the time to review and select a commercial solution (<a href="https://azure.microsoft.com/en-us/services/azure-migrate/">Azure Migrate</a> requires to create a <code class="language-plaintext highlighter-rouge">VM</code> on-premises which was not possible). At the end of the day I came up with a semi-automated process that did the trick, but I felt that not much work would be required to empower teams to price <code class="language-plaintext highlighter-rouge">VMs</code> based on a limited data set.<!--more--></p>

<h2 id="requirements">Requirements</h2>

<p>I wanted to build something that would fit my use case (<code class="language-plaintext highlighter-rouge">AUD</code> and <code class="language-plaintext highlighter-rouge">en-au</code>) but could also be used by people anywhere:</p>

<ul>
  <li>Support thousands of <code class="language-plaintext highlighter-rouge">VMs</code></li>
  <li>Support all currencies</li>
  <li>Support all cultures</li>
  <li>Ability to automate refreshing of the pricing</li>
  <li><del>Timeboxed to a weekend</del></li>
</ul>

<p><strong>Note</strong>: you can find the code on <a href="https://github.com/gabrielweyer/azure-vm-pricing#readme">GitHub</a>.</p>

<h2 id="what-i-came-up-with">What I came up with</h2>

<p>My first goal was to retrieve the pricing from <code class="language-plaintext highlighter-rouge">Azure</code>. I initially considered the <a href="https://docs.microsoft.com/en-us/previous-versions/azure/reference/mt219005(v=azure.100)">Resource RateCard</a> (part of the <code class="language-plaintext highlighter-rouge">Billing API</code>) but the banner below didn’t fill me with confidence:</p>

<p><img src="/assets/azure-vm-pricing/resource-ratecard.png" alt="Resource RateCard" /></p>

<p>The <code class="language-plaintext highlighter-rouge">Billing API</code> requires authentication and parameters to be passed in, which would have increased the complexity of the solution. I knew one place would have mostly up-to-date pricing: the <a href="https://azure.microsoft.com/en-au/pricing/details/virtual-machines/windows/">Virtual Machines Pricing</a> page. This page displays all the available instances for a specific region. It is also possible to select a culture, currency and operating system. There was one problem though: the data is available as <code class="language-plaintext highlighter-rouge">HTML</code> markup instead of an <code class="language-plaintext highlighter-rouge">API</code>.</p>

<h3 id="puppeteer">Puppeteer</h3>

<p><a href="https://pptr.dev/">Puppeteer</a> allows you to control <code class="language-plaintext highlighter-rouge">Chrome</code> or as the project puts it:</p>

<blockquote>
  <p>Puppeteer is a Node library which provides a high-level API to control Chrome or Chromium over the DevTools Protocol. Puppeteer runs headless by default, but can be configured to run full (non-headless) Chrome or Chromium.</p>
</blockquote>

<p>It feels more natural to write a crawler in <code class="language-plaintext highlighter-rouge">JavaScript</code> (<code class="language-plaintext highlighter-rouge">JavaScript</code> is the language of the web after all). According to my limited <a href="https://github.com/gabrielweyer/ui-tests">experience</a>, <code class="language-plaintext highlighter-rouge">Puppeteer</code> is also significantly faster than <code class="language-plaintext highlighter-rouge">Selenium Web Driver</code>. I didn’t bother creating a <code class="language-plaintext highlighter-rouge">npm</code> package so you’ll have to clone the <a href="https://github.com/gabrielweyer/azure-vm-pricing#parser">repository</a> and follow the instructions. This is the kind of output you can expect from the tool:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"instance"</span><span class="p">:</span><span class="w"> </span><span class="s2">"B1S"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"vCpu"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ram"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"payAsYouGo"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.028</span><span class="p">,</span><span class="w">
    </span><span class="nl">"oneYearReserved"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.019</span><span class="p">,</span><span class="w">
    </span><span class="nl">"threeYearReserved"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.014</span><span class="p">,</span><span class="w">
    </span><span class="nl">"threeYearReservedWithAzureHybridBenefit"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.009</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="err">//</span><span class="w"> </span><span class="err">Many</span><span class="w"> </span><span class="err">more</span><span class="w"> </span><span class="err">instances</span><span class="w">
</span><span class="p">]</span></code></pre></figure>

<p>I made the assumption that a single culture and currency will be used through a pricing session and this is why I only encoded the region and operating system in the <a href="https://github.com/gabrielweyer/azure-vm-pricing#parser-output">generated file names</a>. Calling this tool can easily be automated as it doesn’t require any configuration and generates files on disk. You could run it at regular intervals and publish the artefacts.</p>

<p>Once we’ve got our hands on the pricing, all we need to do is size the <code class="language-plaintext highlighter-rouge">VMs</code> and cost them.</p>

<h3 id="coster">Coster</h3>

<p>The <code class="language-plaintext highlighter-rouge">Coster</code> is a <code class="language-plaintext highlighter-rouge">.NET Core</code> console application. Again, I didn’t bother pushing a <code class="language-plaintext highlighter-rouge">NuGet</code> package so you’ll have to build from <a href="https://github.com/gabrielweyer/azure-vm-pricing#coster">source</a>. You’ll need the pricing files generated by the <code class="language-plaintext highlighter-rouge">Parser</code>. The input expected by the <code class="language-plaintext highlighter-rouge">Coster</code> is a <code class="language-plaintext highlighter-rouge">CSV</code> file with the following format:</p>

<figure class="highlight"><pre><code class="language-csv" data-lang="csv">Region,Name,CPU,RAM,Operating System
australia-southeast,SuperName,8,64,windows</code></pre></figure>

<p>Once done, the <code class="language-plaintext highlighter-rouge">Coster</code> will write a <code class="language-plaintext highlighter-rouge">CSV</code> file:</p>

<figure class="highlight"><pre><code class="language-csv" data-lang="csv">Region,Name,Operating System,Instance,CPU,RAM,Pay as You Go,One Year Reserved,Three Year Reserved,Three Year Reserved with Azure Hybrid Benefit
australia-southeast,SuperName,windows,E8 v3,8,64,1.006,0.74334,0.60803,0.24003</code></pre></figure>

<h2 id="conclusion">Conclusion</h2>

<p>Let me know if you’re using these tools and I’ll tidy up and publish packages on <code class="language-plaintext highlighter-rouge">npm</code> and <code class="language-plaintext highlighter-rouge">NuGet</code>. I can’t say I’ve tested them extensively so be ready for some rough edges!</p>

:ET