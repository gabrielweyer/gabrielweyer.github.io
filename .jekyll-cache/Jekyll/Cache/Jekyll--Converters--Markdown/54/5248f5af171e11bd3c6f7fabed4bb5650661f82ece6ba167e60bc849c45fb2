I"±"<p>Google Chrome Extensions have beenÂ <a href="http://en.wikipedia.org/wiki/Google_Chrome#Extensions">launched</a>Â officially in January 2010. Their goal is to extend the browser by providing additional features, for example you could add a weather extension and then be able to see the weatherâ€™s forecast in your city in one click. Extensions have become widely popular and youâ€™re now wondering what could be the issue with them.</p>

<h1 id="much-more-power-than-expected">Much more power than expected</h1>

<p>Google <a href="/assets/2014-01-07-why-you-should-not-use-chrome-extensions/ads-13.png">uses</a> a system ofÂ <a href="https://support.google.com/chrome_webstore/answer/186213?hl=en&amp;rd=1">permissions</a>Â to determine what an extension will be able to do once installed. Those permissions are divided into three alert levels: high, medium and low. So far, so good? Not really, even the low level allows an extension to harvest your browsing history and the content of your clipboard.</p>

<p>Extensions are built using JavaScript and HTML. Those are the exact same technologies used on websites. Iâ€™m sure youâ€™re aware how modern websites refresh part of their content without reloading the whole page. Extensions can do this too: nothing is preventing a low level alert extension to detect that youâ€™re pasting your email and passwordÂ on Facebook in order to login. Then the extension can send the collected information to a remote server.</p>

<p>In this case the exploit is fairly limited, you need the user to be copying / pasting the email and password for this to work (the extension would also collect everything that the user is copying and pasting). Whats about the medium and high level alert? This is where the real fun start, at this level of trust extensions can do whatever they want!</p>

<p>A medium alert level extension can generate HTML elements on a page. It could perfectly hide a login form, replace it by itâ€™s own, harvest your credentials and submit the hidden login form. A high alert level extension can do similar things but on your computer! This means that it could take your picture via your webcam, browse your hard drive looking for interesting filesâ€¦</p>

<p>You would think that all of this is hypothetical and Google would certainly remove any malicious extension, but in this case you would be wrong.<!--more--></p>

<h1 id="technical-breakdown-of-a-malicious-extension">Technical breakdown of a malicious extension</h1>

<p><strong>Warning</strong>: this part is somehow technical.</p>

<p>On the 5th of December 2013 I noticed that ads started to appear on top of Google Image Search. Iâ€™ve never seen ads there before. It also had this strange sentence â€œAds not from this siteâ€. I was intrigued and it didnâ€™t take me long to find the culprit:Â <a href="https://chrome.google.com/webstore/detail/awesome-screenshot-captur/alelhddbbhepgpmgidjdcjakblofbmce/details">Awesome Screenshot: Capture &amp; Annotate</a>.</p>

<p>Turns out a new version was published on the 5th of December and this is when it started to display ads. I wasnâ€™t the only user to notice:</p>

<p><a href="/assets/2014-01-07-why-you-should-not-use-chrome-extensions/ads-13.png"><img src="/assets/2014-01-07-why-you-should-not-use-chrome-extensions/ads-13.png" alt="ads-1" /></a> <a href="/assets/2014-01-07-why-you-should-not-use-chrome-extensions/ads-23.png"><img src="/assets/2014-01-07-why-you-should-not-use-chrome-extensions/ads-23.png" alt="ads-2" /></a> <a href="/assets/2014-01-07-why-you-should-not-use-chrome-extensions/ads-32.png"><img src="/assets/2014-01-07-why-you-should-not-use-chrome-extensions/ads-32.png" alt="ads-3" /></a></p>

<p>After a couple of hours everything went back to normal: I enabled the extension again and noticed that it wasnâ€™t displaying ads anymore. I decided to dig deeper and downloaded the source code of the extension.</p>

<p>Everything starts here:Â <code class="language-plaintext highlighter-rouge">\javascripts\content_script.js</code> [<a href="https://github.com/gabrielweyer/code-sample/blob/master/technical-blog/chrome-ext/src/3.5.7/javascripts/content_script.js#L763-L781">line:763-781</a>]</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/8248634.js"> </script>

<p>This code is commented. I suspect this is because they pushed a second version the same day (this file was the only one modified on the 5th of December). Itâ€™s very easy to understand whatâ€™s going on here: if the user is browsing a site owned by Google the code should callÂ <code class="language-plaintext highlighter-rouge">addAD</code>Â (the function name in itself is rather explicit). The script will also reload the ads 1.5 seconds after the user has finished typing in the search bar.</p>

<p>The functionÂ <code class="language-plaintext highlighter-rouge">addAD</code>Â is located in the same fileÂ `\javascripts\content_script.js [<a href="https://github.com/gabrielweyer/code-sample/blob/master/technical-blog/chrome-ext/src/3.5.7/javascripts/content_script.js#L631-L668">line:631-668</a>]. The code is a bit too long to past here but itâ€™s calling another function [<a href="https://github.com/gabrielweyer/code-sample/blob/master/technical-blog/chrome-ext/src/3.5.7/javascripts/content_script.js#L635">line:635</a>]</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/8248711.js"> </script>

<p>This function will retrieve the ads and create the markup [<a href="https://github.com/gabrielweyer/code-sample/blob/master/technical-blog/chrome-ext/src/3.5.7/javascripts/content_script.js#L644-L646">line:644-646</a>]</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/8248593.js"> </script>

<p>The best part is located here:Â <code class="language-plaintext highlighter-rouge">\javascripts\bg.js</code> [<a href="https://github.com/gabrielweyer/code-sample/blob/master/technical-blog/chrome-ext/src/3.5.7/javascripts/bg.js#L154-L184">line:154-184</a>]</p>

<p>First theyâ€™re doing a HTTP GET at:Â <a href="http://api.hostip.info/get_json.php">http://api.hostip.info/get_json.php</a>Â and getting JSON as a reply</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/8248818.js"> </script>

<p>The funny part is that Iâ€™m located in Melbourne and I was not using a proxy or a VPN at this time!</p>

<p>Then this line says it all [<a href="https://github.com/gabrielweyer/code-sample/blob/master/technical-blog/chrome-ext/src/3.5.7/javascripts/bg.js#L162">line:162</a>]</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/8248849.js"> </script>

<p>I find it really scary. These guys are obviously not very smart, they could just have replaced Google Ads by their own and keep exactly the same design. This way they could have stayed unnoticed for much longer. This also means (most likely) that there is nothing preventing extensions from harvesting passwords (either directly via JavaScript or by inserting DOM elements in the page). This extension has over a million users, the fact that they were not taken down indicates that Google needs to improve its security practices for extensions.</p>

<h1 id="why-hasnt-this-been-exploited-more">Why hasnâ€™t this been exploited more?</h1>

<p>I suspect it has been used widely already. Recipe: create a popular extension (emulate a paying service for free, launch a football world cup trackerâ€¦), push an update that will sometimes be malicious. If the number of reports does not reach a certain threshold Google wonâ€™t investigate. Rinse and repeat.</p>

<p>In fact this same extension was used again but for a different attack on the 17th of December:</p>

<p><a href="/assets/2014-01-07-why-you-should-not-use-chrome-extensions/data-collection-1.png"><img src="/assets/2014-01-07-why-you-should-not-use-chrome-extensions/data-collection-1.png" alt="data-collection-1" /></a> <a href="/assets/2014-01-07-why-you-should-not-use-chrome-extensions/data-collection-2.png"><img src="/assets/2014-01-07-why-you-should-not-use-chrome-extensions/data-collection-2.png" alt="data-collection-2" /></a></p>

<p>There is no accountability: most of the companies publishing extensions are completely unknown. Even if Google was to act they could just create new extensions under another name.</p>

<h1 id="take-away">Take Away</h1>

<p>I stopped using Chrome extensions and I think you should too. The risks vastly overshadow the benefits. In fact I think it is safe to use Chrome Extensions in a couple of cases:</p>

<ul>
  <li>When they come from a reputable source (Google, Evernote, Dropboxâ€¦)</li>
  <li>When theyâ€™re part of a service youâ€™re paying for (1Password for example)</li>
  <li>When theyâ€™re open source</li>
</ul>

:ET