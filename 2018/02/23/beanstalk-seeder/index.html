<!DOCTYPE html>
<html>
<head>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Beanstalk Seeder &#8211; Gabriel Weyer &#8211; A somewhat technical blog</title>
    <link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Emulates the SQS Daemon surrounding an Elastic Beanstalk Worker Tier so that you can replicate the interaction between a Web Tier and a Worker Tier on your machine.">
    <meta name="robots" content="all">
    <meta name="author" content="Gabriel Weyer">
    
    <meta name="keywords" content="OSS">
    <link rel="canonical" href="https://gabrielweyer.github.io/2018/02/23/beanstalk-seeder/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for Gabriel Weyer - A somewhat technical blog" href="/feed.xml" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?201902190345" type="text/css">

    <!-- Fonts -->
    
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
    

    <!-- MathJax -->
    

    <!-- Verifications -->
    
    

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
    <meta name="twitter:site" content="@gabrielweyer" />
    <meta name="twitter:creator" content="@gabrielweyer" />
    
    <meta name="twitter:title" content="Beanstalk Seeder" />
    <meta name="twitter:description" content="Emulates the SQS Daemon surrounding an Elastic Beanstalk Worker Tier so that you can replicate the interaction between a Web Tier and a Worker Tier on your machine." />
    <meta name="twitter:url" content="https://gabrielweyer.github.io/2018/02/23/beanstalk-seeder/" />

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">

    
</head>

<body class="site">
  
	

  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="/" class="site-title">Gabriel Weyer<span class="site-sub-title"> &#8211; A somewhat technical blog</span></a>
      <nav class="site-nav">
        




    
    
    
    
        <a href="/about/">About</a>
    

    


      </nav>
      <div class="clearfix"></div>
      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>Beanstalk Seeder</h1>
  <span class="post-meta">Feb 23, 2018</span><br>
  
  <span class="post-meta small">
  
    3 minute read
  
  </span>
</div>

<article class="post-content">
  <p><code class="highlighter-rouge">Elastic Beanstalk</code> is a great platform, it offers both a <code class="highlighter-rouge">Web</code> tier and a <code class="highlighter-rouge">Worker</code> tier. I recently wrote about <a href="/2018/01/28/simple-routing-elastic-beanstalk-worker/">Simple Routing</a> one of my library that allows you to route a <code class="highlighter-rouge">SQS</code> message to a specific endpoint on the <code class="highlighter-rouge">Worker</code>.</p>

<p>While <code class="highlighter-rouge">Beanstalk</code> works great once it’s deployed to <code class="highlighter-rouge">AWS</code> there is no easy way to run it locally. As soon as you want to execute an end-to-end flow involving both the <code class="highlighter-rouge">Web</code> and the <code class="highlighter-rouge">Worker</code> you need to manually <code class="highlighter-rouge">POST</code> requests to the <code class="highlighter-rouge">Worker</code> using <a href="https://www.getpostman.com/">Postman</a> which is cumbersome and error-prone.</p>

<p>As it core all the <a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features-managing-env-tiers.html">SQS daemon</a> does is dequeue messages from a <code class="highlighter-rouge">SQS</code> queue and <code class="highlighter-rouge">POST</code> it to a specified endpoint. With this goal in mind I wrote <a href="https://github.com/gabrielweyer/beanstalk-seeder">Beanstalk Seeder</a>.<!--more--></p>

<p>I had the following objectives:</p>

<ul>
  <li>Users should be able to get up and running quickly</li>
  <li>Meaningful logging</li>
  <li>Transform the <code class="highlighter-rouge">SQS</code> <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-message-attributes.html">message attributes</a> into HTTP headers (in order to support <a href="https://github.com/gabrielweyer/simple-routing">Simple Routing</a>)</li>
</ul>

<h2 id="get-up-and-running-quickly">Get up and running quickly</h2>

<p>You can get <code class="highlighter-rouge">Beanstalk Seeder</code> from <a href="https://github.com/gabrielweyer/beanstalk-seeder/releases">GitHub releases</a>. Download the archive and extract it somewhere.</p>

<p><code class="highlighter-rouge">Beanstalk Seeder</code>’s <a href="https://github.com/gabrielweyer/beanstalk-seeder#configuration">configuration</a> is detailed in the <code class="highlighter-rouge">README</code>. All you need is a <code class="highlighter-rouge">iAM</code> user, the <code class="highlighter-rouge">Worker</code> <code class="highlighter-rouge">URI</code> and the <code class="highlighter-rouge">SQS</code> queue <code class="highlighter-rouge">URI.</code></p>

<h2 id="meaningful-logging">Meaningful logging</h2>

<p>When running a third-party tool, it’s critical to get meaningful logging as the binary is a black-box for the end user. I use <a href="https://nblumhardt.com/2016/06/structured-logging-concepts-in-net-series-1/#what-is-structured-logging">structured logging</a> in order to make querying the log events a breeze. My logging framework of choice is <a href="https://blog.getseq.net/serilog-tutorial/">Serilog</a>.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">loggerConfiguration</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">LoggerConfiguration</span><span class="p">()</span>
    <span class="p">.</span><span class="n">Destructure</span><span class="p">.</span><span class="n">ByTransforming</span><span class="p">&lt;</span><span class="n">MessageAttributeValue</span><span class="p">&gt;(</span><span class="n">Destructure</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Destructure</span><span class="p">.</span><span class="n">ByTransforming</span><span class="p">&lt;</span><span class="n">Message</span><span class="p">&gt;(</span><span class="n">Destructure</span><span class="p">)</span>
    <span class="p">.</span><span class="n">MinimumLevel</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="n">serilogLevel</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Enrich</span><span class="p">.</span><span class="nf">WithDemystifiedStackTraces</span><span class="p">()</span>
    <span class="p">.</span><span class="n">Enrich</span><span class="p">.</span><span class="nf">FromLogContext</span><span class="p">()</span>
    <span class="p">.</span><span class="n">WriteTo</span><span class="p">.</span><span class="nf">Console</span><span class="p">(</span><span class="n">serilogLevel</span><span class="p">);</span></code></pre></figure>

<p>The previous snippet highlights only a few of the <code class="highlighter-rouge">Serilog</code> features.</p>

<h3 id="the-structure-capturing-operator">The structure-capturing operator</h3>

<p><code class="highlighter-rouge">MessageAttributeValue</code> and <code class="highlighter-rouge">Message</code> are both defined in the <code class="highlighter-rouge">awssdk.sqs</code> <code class="highlighter-rouge">NuGet</code> package. I’m interested in logging only some of their properties, <code class="highlighter-rouge">Serilog</code> has the ability to capture object via the <a href="https://nblumhardt.com/2016/08/serialized-data-structured-logging-concepts-in-net-6/#capturing-objects">structure-capturing operator</a>.</p>

<h3 id="enrichment">Enrichment</h3>

<blockquote>
  <p>Enrichment is the act of adding additional properties to events, other than the ones originating from the message template.</p>
</blockquote>

<p><code class="highlighter-rouge">Serilog</code> supports <a href="https://blog.getseq.net/serilog-tutorial/#enrichingwithambientcontext">ambient context</a>. I’m also using the excellent <a href="https://github.com/benaadams/Ben.Demystifier">Ben.Demystifier</a> for getting nicer stack traces.</p>

<h3 id="sinks">Sinks</h3>

<p>By default, <code class="highlighter-rouge">Serilog</code> does not log anywhere. In order to record events you’ll need to configure one or more <code class="highlighter-rouge">Sink</code>s. In this case I’m writing to the console but they are <a href="https://github.com/serilog/serilog/wiki/Provided-Sinks">many other</a> <code class="highlighter-rouge">Sink</code>s available.</p>

<h3 id="result">Result</h3>

<p><img src="/assets/beanstalk-seeder/events.png" alt="HTTP Path" /></p>

<p>I hope the recorded events are descriptive enough so that an end user know what’s happening:</p>

<ul>
  <li>First I display the settings used, this is important as they could come from the <code class="highlighter-rouge">appsettings.json</code>, environment variables or even the <a href="https://docs.microsoft.com/en-us/aspnet/core/security/app-secrets?tabs=visual-studio#secret-manager">user secrets</a> if the environment is <code class="highlighter-rouge">Development</code>.</li>
  <li>Then using the <code class="highlighter-rouge">structure-capturing operator</code> I log the relevant <code class="highlighter-rouge">SQS</code> message properties.</li>
  <li>Instead of logging the complete HTTP request I log the content of the body and the relevant headers.</li>
  <li>When deleting the message, I log the <code class="highlighter-rouge">ReceiptHandle</code>, this is the value used to delete a message and the user can correlate it to what was displayed above.</li>
  <li>Finally, rather than not displaying anything when there are no messages in the queue I inform the user that’s the case and how long I’ll wait before retrying.</li>
</ul>

<h2 id="interestings-bits">Interestings bits</h2>

<p>I’m using a <a href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.cancellationtokensource?view=netcore-2.0">CancellationTokenSource</a> so that the user can stop the message pump at any time (relying on <a href="https://docs.microsoft.com/en-us/dotnet/api/system.console.cancelkeypress?view=netcore-2.0">Console.CancelKeyPress</a>).</p>

<p>The <a href="https://github.com/gabrielweyer/beanstalk-seeder/blob/ca47d6f84fe748915a22de63b23a34ef735a88ae/src/BeanstalkSeeder/Services/MessagePump.cs">MessagePump</a> <code class="highlighter-rouge">class</code> is the only <code class="highlighter-rouge">class</code> with some logic. I wrote some <a href="https://github.com/gabrielweyer/beanstalk-seeder/blob/ca47d6f84fe748915a22de63b23a34ef735a88ae/tests/BeanstalkSeederTests/MessagePumpTests.cs">tests</a> around the cancellation token, the transformation of <code class="highlighter-rouge">SQS</code> message attributes into HTTP headers and the back-off when no messages are available in the queue.</p>

<h2 id="conclusion">Conclusion</h2>

<p>I hope you’ll find <a href="https://github.com/gabrielweyer/beanstalk-seeder">Beanstalk Seeder</a> as useful as I did, combined with <a href="https://github.com/gabrielweyer/simple-routing">Simple Routing</a> it simplified and streamlined my <code class="highlighter-rouge">Elastic Beanstalk</code> development.</p>

<p>I also wanted to point out that <code class="highlighter-rouge">Beanstalk Seeder</code> is platform agnostic. It doesn’t matter if you’re developing using <code class="highlighter-rouge">Node.js</code>, <code class="highlighter-rouge">Go</code> or any other of the <a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/concepts.platforms.html">Elastic Beanstalk supported platforms</a>, all you need to do is install the latest <a href="https://www.microsoft.com/net/download/windows">.NET Core runtime</a> (available on <code class="highlighter-rouge">Windows</code>, <code class="highlighter-rouge">macOS</code> and <code class="highlighter-rouge">Linux</code>).</p>


</article>













      </div>
    </div>
  </div>

  <footer class="center">
  <div class="measure">
    <small>
      Gabriel Weyer. <a href="https://github.com/johnotander/pixyll">Theme</a> crafted with &lt;3 by <a href="https://twitter.com/4lpine">John Otander</a>.
    </small>
  </div>
</footer>


</body>
</html>
