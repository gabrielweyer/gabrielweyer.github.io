<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Testing anti-patterns #1 &#8211; Gabriel Weyer &#8211; A somewhat technical blog</title>
    <link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="List 6 testing anti-patterns.">
    <meta name="robots" content="all">
    <meta name="author" content="Gabriel Weyer">
    
    <meta name="keywords" content="Testing, Testing anti-patterns">
    <link rel="canonical" href="https://gabrielweyer.net/2018/03/24/testing-anti-patterns-1/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for Gabriel Weyer - A somewhat technical blog" href="/feed.xml" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?201906082002" type="text/css">

    <!-- Fonts -->
    
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
    

    <!-- MathJax -->
    

    <!-- Verifications -->
    
    

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
    <meta name="twitter:site" content="@gabrielweyer" />
    <meta name="twitter:creator" content="@gabrielweyer" />
    
    <meta name="twitter:title" content="Testing anti-patterns #1" />
    <meta name="twitter:description" content="List 6 testing anti-patterns." />
    <meta name="twitter:url" content="https://gabrielweyer.net/2018/03/24/testing-anti-patterns-1/" />

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">

    
</head>

<body class="site">
  
	

  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="/" class="site-title">Gabriel Weyer<span class="site-sub-title"> &#8211; A somewhat technical blog</span></a>
      <nav class="site-nav">
        




    
    
    
    
        <a href="/about/">About</a>
    

    


      </nav>
      <div class="clearfix"></div>
      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>Testing anti-patterns #1</h1>
  <span class="post-meta">Mar 24, 2018</span><br>
  
  <span class="post-meta small">
  
    5 minute read
  
  </span>
</div>

<article class="post-content">
  <p>I often ask candidates to define a good unit test. This is the starting point of a conversation around testing strategies and delivering value. Over the years I’ve heard opinions ranging from <code class="highlighter-rouge">the 100% coverage</code>, passing by <code class="highlighter-rouge">testing is for testers</code>, all the way to <code class="highlighter-rouge">we don't do automated testing</code>. If the notion of a <em>good test</em> can be subjective, it is easier to identify a <strong>bad</strong> test. Bloggers have written about this topic at length but I thought I would try paraphrasing the same content hoping nobody would notice.</p>

<p>I must admit I have written - quite - a few bad tests myself and that’s fine. We all make mistakes, how we handle those mistakes is what help us grow:</p>

<ul>
  <li>It’s important to understand why the mistake happened and put in place measures to prevent the same mistake from happening again</li>
  <li>Equally we should challenge existing practices, they might be there for a good reason but they might instead be there for a <strong>bad</strong> reason</li>
</ul>

<!--more-->

<p>Here are a few anti-patterns I’ve noticed over the years:</p>

<h2 id="ignored-or-commented-test">Ignored or commented test</h2>

<p>Have you ever seen this?</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="na">[Ignore]</span>
<span class="na">[TestMethod]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">Test</span><span class="p">()</span></code></pre></figure>

<p>Luckily only <code class="highlighter-rouge">MSTest</code> allows to ignore a test without providing a message, both <code class="highlighter-rouge">xUnit</code> and <code class="highlighter-rouge">NUnit</code> require the developer to provide a message. What’s worse is that the message of the commit ignoring the test often reads <code class="highlighter-rouge">"fixed" test YOLO LMAO</code> and you’re left wondering what deep philosophical message lies hidden behind those mundane words.</p>

<p>In the case of a <em>commented test</em> the solution is simple: <strong>delete</strong> it. Regarding <em>ignored tests</em>, have a quick read through and run them. If you can’t get them to pass, <strong>delete</strong> them too. Ignored / commented tests will only confuse future developers. You should treat your test code the same way you treat your production code: if a piece of code has no use anymore it should go.</p>

<p><strong>Ask yourself</strong>: why am I ignoring this test, what conditions should be met to enable it again? Then write a <strong>descriptive</strong> ignore message.</p>

<h2 id="non-thread-safe">Non-thread-safe</h2>

<p>The first thing that is wrong with this test is that it’s recording log messages so that they can be asserted at a later stage (see <a href="#asserting-log-messages">below</a> for the log anti-pattern):</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">logger</span>
    <span class="p">.</span><span class="nf">When</span><span class="p">(</span><span class="n">l</span> <span class="p">=&gt;</span> <span class="n">l</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="n">Arg</span><span class="p">.</span><span class="n">Any</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;()))</span>
    <span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="n">ci</span> <span class="p">=&gt;</span> <span class="n">_logs</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">ci</span><span class="p">.</span><span class="n">Arg</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;()));</span></code></pre></figure>

<p>But this was not the only issue with this statement. After making an unrelated change this test failed. I ran it again on its own and it passed, so this test was failing intermittently and I was also getting different <code class="highlighter-rouge">Exception</code> <code class="highlighter-rouge">Type</code>s! The <code class="highlighter-rouge">NullReferenceException</code> wasn’t meaningful but I also got an <code class="highlighter-rouge">IndexOutOfRangeException</code> when adding an element to the <code class="highlighter-rouge">List</code>.</p>

<p>It turned out the code under test was multi-threaded and multiple threads were trying to add to the <code class="highlighter-rouge">List</code> at the same time. The <a href="https://docs.microsoft.com/en-us/dotnet/api/system.collections.generic.list-1?view=netframework-4.7.1#Thread_Safety">.NET API browser</a> makes it clear than <code class="highlighter-rouge">List</code> is not thread-safe:</p>

<blockquote>
  <p>Any instance members are not guaranteed to be thread safe. […] <strong>To ensure thread safety, lock the collection during a read or write operation</strong>.</p>
</blockquote>

<p>In this instance the solution was to lock the <code class="highlighter-rouge">List</code> when adding to it:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">logger</span>
    <span class="p">.</span><span class="nf">When</span><span class="p">(</span><span class="n">l</span> <span class="p">=&gt;</span> <span class="n">l</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="n">Arg</span><span class="p">.</span><span class="n">Any</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;()))</span>
    <span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="n">ci</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">lock</span> <span class="p">(</span><span class="n">_logs</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_logs</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">ci</span><span class="p">.</span><span class="n">Arg</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;());</span>
        <span class="p">}</span>
    <span class="p">});</span></code></pre></figure>

<p><strong>Ask yourself</strong>: most of the code we write is not performance critical, do you need to create multiple threads?</p>

<h2 id="failure-without-enough-context">Failure without enough context</h2>

<p>There is nothing more frustrating than having a build failing on the build server and be faced by this kind of log:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Assert.True() Failure
Expected: True
Actual:   False</code></pre></figure>

<p>From there things only get worse, when you look at the actual assert you discover it’s asserting multiple things at the same time and you’ve no idea which one went wrong:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Assert</span><span class="p">.</span><span class="nf">True</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">A</span> <span class="p">==</span> <span class="n">b</span><span class="p">.</span><span class="n">A</span> <span class="p">&amp;&amp;</span> <span class="n">a</span><span class="p">.</span><span class="n">B</span> <span class="p">==</span> <span class="n">b</span><span class="p">.</span><span class="n">B</span> <span class="p">&amp;&amp;</span> <span class="n">a</span><span class="p">.</span><span class="n">C</span> <span class="p">==</span> <span class="n">b</span><span class="p">.</span><span class="n">C</span><span class="p">);</span></code></pre></figure>

<p>If you need to compare objects you can use an assertion library such as <a href="http://fluentassertions.com/">Fluent Assertions</a> or <a href="https://github.com/shouldly/shouldly">Shouldly</a>.</p>

<p><strong>Ask yourself</strong>: if I make this test break, would I have enough context based on <strong>only</strong> the logs to understand what went wrong?</p>

<h2 id="asserting-log-messages">Asserting log messages</h2>

<p>Please don’t do this:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">logger</span><span class="p">.</span><span class="nf">Received</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="nf">Info</span><span class="p">(</span><span class="s">"Super important log"</span><span class="p">);</span></code></pre></figure>

<p>Logging is an implementation detail, asserting log messages is over-specifying.</p>

<p>On the other hand, if recording that something happened is critical from a business point of view you don’t want to use logging for this purpose as developers should be able to modify logging as they see fit.</p>

<p>Tracking business events can be achieved in different ways:</p>

<ul>
  <li>Via your <code class="highlighter-rouge">APM</code> service, both <a href="https://docs.microsoft.com/en-us/azure/application-insights/app-insights-api-custom-events-metrics#trackevent">Application Insights</a> and <a href="https://docs.newrelic.com/docs/insights/insights-data-sources/custom-data/insert-custom-events-new-relic-apm-agents">New Relic</a> can track custom events</li>
  <li>Via a service bus. Your code could be instrumented to emit messages and any interested service can subscribe to them</li>
</ul>

<p><strong>Ask yourself</strong>: is this the best way of doing this? Read the documentation of the systems you’re currently using, you’ll quite often discover features you had no idea existed.</p>

<h2 id="nullreferenceexception-in-constructor">NullReferenceException in constructor</h2>

<p>Don’t assert than your constructors are throwing a <code class="highlighter-rouge">NullReferenceException</code> when being passed a <code class="highlighter-rouge">null</code>. Your <code class="highlighter-rouge">IoC</code> <code class="highlighter-rouge">container</code> will throw an <code class="highlighter-rouge">Exception</code> anyway when trying to resolve the dependencies.</p>

<p><strong>Ask yourself</strong>: do I need to test third-party libraries?</p>

<h2 id="sanity-check">Sanity check</h2>

<p>Quite often when starting a new project, developers will create a <em>sanity check</em> test. This is a test that <strong>should</strong> pass and if it were to fail it would mean that things are terribly wrong. An example of such a test is this:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Assert</span><span class="p">.</span><span class="nf">True</span><span class="p">(</span><span class="k">true</span><span class="p">);</span></code></pre></figure>

<p>I’ve never seen this kind of test fail. Moreover, this test does not have any value as it doesn’t give me any confidence that the code is behaving the way it is supposed to.</p>

<p><strong>Ask yourself</strong>: Can I break this test by altering the correctness of the production code?</p>


</article>













      </div>
    </div>
  </div>

  <footer class="center">
  <div class="measure">
    <small>
      Gabriel Weyer. <a href="https://github.com/johnotander/pixyll">Theme</a> crafted with &lt;3 by <a href="https://twitter.com/4lpine">John Otander</a>.
    </small>
  </div>
</footer>


</body>
</html>
